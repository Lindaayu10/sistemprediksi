[
  {
    "Id": "244042",
    "ThreadId": "71551",
    "Html": "<p>In the Tests/ directory, there is a sample output file 14excel5.xls, presumably generated by the corresponding 14excel5.php. We indeed are able to produce an .xls with 14Excel5.php, but we can't produce the same one. We can produce something that *looks* exactly the same as the supplied one, but only when you open it in Excel 2007, OO.o 3.0, and a recent Gnumeric.</p>\r\n<p>Our problem is Excel 97. The 14Excel5.xls that we produce by running the corresponding script does not display images when opened under Excel 97. We suspect that there is a problem with how the routines in Escher.php write the image metadata to the .xls</p>\r\n<p>We appreciate any and all help. We'll be looking at the .xls spec and Escher.php to see if we can fix this ourselves.</p>",
    "PostedDate": "2009-10-09T14:45:05.537-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "244048",
    "ThreadId": "71551",
    "Html": "<p>Thanks for investigating this. I must admit I haven't tested in Excel 97. As far as I remember Excel 2003 is ok, right?</p>\r\n<p>It is a while ago I looked at this, but I remember there were great difficulties getting images to work in PHPExcel_Writer_Excel5.</p>\r\n<p>Information was found these places:</p>\r\n<p><a href=\"http://www.microsoft.com/interop/docs/OfficeBinaryFormats.mspx\">http://www.microsoft.com/interop/docs/OfficeBinaryFormats.mspx</a> (Office Drawing)</p>\r\n<p><a href=\"http://msdn.microsoft.com/en-us/library/cc441433.aspx\">http://msdn.microsoft.com/en-us/library/cc441433.aspx</a></p>\r\n<p>Unfortunately, I found those documents quite messy. Several records were not documented. Let me know if I can help. Right now I need to find a way to test in Excel 97.</p>",
    "PostedDate": "2009-10-09T15:11:15.307-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "246673",
    "ThreadId": "71551",
    "Html": "<p>Perl's Spreadsheet::ExcelWriter can write images into BIFF 8 files in a way that Excel 97 seems to be able to understand. I have spent most of this week trying to understand what Spreadsheet::ExcelWriter is doing and figuring out BIFF. The biggest differences with PHPExcel seem to be that Spreadsheet::ExcelWriter writes a checksum for the image (an MD5 sum) in the Dgg block and uses it as an RgbUid, whereas PHPExcel leaves it zeroed out. Spreadsheet::ExcelWriter also writes two more Escher records: Opt and SplitMenuColors. Spreadsheet::ExcelWriter has other differences outside of the MSODRAWINGGROUP record, but I'm not sure if any of this is relevant. There are other minor differences such as the SpidMax variable differing in the Perl and PHP engines, but I'm not sure if this is relevant.</p>\r\n<p>If you have further hints on how to insert images into BIFF 8 documents such that Excel 97 can read it, they would be most welcome.</p>",
    "PostedDate": "2009-10-16T12:32:29.417-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "246685",
    "ThreadId": "71551",
    "Html": "<blockquote style=\"border:solid .1em #ccc;font-style:italic;margin:.25em 1em 0 1em;padding:0 .25em 0 .25em\"><strong>jordigh wrote:</strong><br>\r\n<p>Perl's Spreadsheet::ExcelWriter can write images into BIFF 8 files in a way that Excel 97 seems to be able to understand. I have spent most of this week trying to understand what Spreadsheet::ExcelWriter is doing and figuring out BIFF. The biggest differences with PHPExcel seem to be that Spreadsheet::ExcelWriter writes a checksum for the image (an MD5 sum) in the Dgg block and uses it as an RgbUid, whereas PHPExcel leaves it zeroed out. Spreadsheet::ExcelWriter also writes two more Escher records: Opt and SplitMenuColors. Spreadsheet::ExcelWriter has other differences outside of the MSODRAWINGGROUP record, but I'm not sure if any of this is relevant. There are other minor differences such as the SpidMax variable differing in the Perl and PHP engines, but I'm not sure if this is relevant.</p>\r\n</blockquote>\r\n<p>Very interesting information. Thanks for testing.</p>\r\n<p>&nbsp;</p>\r\n<blockquote style=\"border:solid .1em #ccc;font-style:italic;margin:.25em 1em 0 1em;padding:0 .25em 0 .25em\"><strong>jordigh wrote:</strong><br>\r\n<p>If you have further hints on how to insert images into BIFF 8 documents such that Excel 97 can read it, they would be most welcome.</p>\r\n</blockquote>\r\n<p>May I suggest that you start out with the an xls file generated by Perl's Spreadsheet::ExcelWriter and try to blank out those pieces of information which PHPExcel is not writing to find out which one is necessary for Excel 97.</p>\r\n<p>You can do like this:</p>\r\n<p>For the MD5 sum, blank it out in a HEX editor replacing with zeros. If it still opens fine in Excel 97, then we can consider it unimportant.</p>\r\n<p>For the OPT and SplitMenuColors records, blank them out in a HEX editor by replacing the record type entry with some &quot;garbage&quot; data. (Then it will just be ignored by Excel 97)</p>\r\n<p>That way we should be able to  find out which piece of information is necessary for Excel 97. I will gladly help doing the HEX edits if you can provide the Perl Excel file with an image. Then maybe you can help trying to open in Excel 97 and say whether the image is there or not.</p>\r\n<p>You are very welcome to upload test files here: <a href=\"http://phpexcel.codeplex.com/WorkItem/View.aspx?WorkItemId=10749\">http://phpexcel.codeplex.com/WorkItem/View.aspx?WorkItemId=10749</a></p>\r\n<p>&nbsp;</p>",
    "PostedDate": "2009-10-16T12:59:26.84-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "246695",
    "ThreadId": "71551",
    "Html": "<p>Thanks for your help.</p>\r\n<p>I have uploaded the test case I'm working with. I'll try to follow your recommendations and remove little by little the data that Spreadsheet::ExcelWriter generates and see if it still works with Excel 97.</p>\r\n<p>I am starting to suspect the problem is not within the MSODRAWINGGROUP record, but best to be sure.</p>",
    "PostedDate": "2009-10-16T13:32:06.69-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "246729",
    "ThreadId": "71551",
    "Html": "<p>Based on your <span style=\"font-family:Courier New\">perl.xls</span> I have uploaded some files that should help locate the error.</p>\r\n<p><a href=\"http://phpexcel.codeplex.com/Project/Download/AttachmentDownload.ashx?ProjectName=PHPExcel&WorkItemId=10749&FileAttachmentId=3447\">excel97-images.zip</a></p>\r\n<p>Here is what I did.<br><br><strong>1.</strong><br>In <span style=\"font-family:Courier New\">perl.xls</span> extract the binary record contents of these records:</p>\r\n<pre>MSODRAWINGGROUP<br>MSODRAWING<br>OBJ</pre>\r\n<p><br> Saved in files:</p>\r\n<pre>MsoDrawingGroup.bin<br>MsoDrawing.bin<br>Obj.bin<br></pre>\r\n<p><br> <strong>2.</strong><br> <span style=\"font-family:Courier New\">index.php</span> writes a blank xls workbook using <span style=\"font-family:Courier New\">PHPExcel_Writer_Excel5</span><br> <br> <strong>3.</strong><br> Hack these  two files in PHPExcel</p>\r\n<pre>PHPExcel\\Writer\\Excel5\\Workbook.php<br>PHPExcel\\Writer\\Excel5\\Worksheet.php</pre>\r\n<p>by editing them in a way so they inject the binary stuff which was extracted from perl.xls<br> <br> Modified was simply this in <span style=\"font-family:Courier New\">PHPExcel\\Writer\\Excel5\\Workbook.php</span>:<br> <br></p>\r\n<div style=\"color:black;background-color:white\">\r\n<pre><span style=\"color:blue\">private</span> <span style=\"color:blue\">function</span> _writeMsoDrawingGroup()<br>{<br>    $record = 0x00EB;<br>    $data = file_get_contents(<span style=\"color:#a31515\">'C:/xampp/htdocs/_phpexcel/MsoDrawingGroup.bin'</span>);<br>    $length = strlen($data);<br>    $header = pack(<span style=\"color:#a31515\">&quot;vv&quot;</span>,  $record, $length);<br><br>    <span style=\"color:blue\">return</span> $this-&gt;writeData($header . $data);<br>}<br></pre>\r\n</div>\r\n<p><br> <br> and this in <span style=\"font-family:Courier New\">PHPExcel\\Writer\\Excel5\\Worksheet.php</span><br> <br></p>\r\n<div style=\"color:black;background-color:white\">\r\n<pre><span style=\"color:blue\">private</span> <span style=\"color:blue\">function</span> _storeMsoDrawing()<br>{<br>    <span style=\"color:green\">// chunk of Escher stream for one shape</span><br>    $record = 0x00EC;            <span style=\"color:green\">// Record identifier</span><br>    $data = file_get_contents(<span style=\"color:#a31515\">'C:/xampp/htdocs/_phpexcel/MsoDrawing.bin'</span>);<br>    $length = strlen($data);<br>    $header = pack(<span style=\"color:#a31515\">&quot;vv&quot;</span>, $record, $length);<br>    $this-&gt;_append($header . $data);<br><br>    <span style=\"color:green\">// OBJ record</span><br>    $record = 0x005D; <span style=\"color:green\">// record identifier</span><br>    $objData = file_get_contents(<span style=\"color:#a31515\">'C:/xampp/htdocs/_phpexcel/Obj.bin'</span>);<br>    $length = strlen($objData);<br>    $header = pack(<span style=\"color:#a31515\">'vv'</span>, $record, $length);<br>    $this-&gt;_append($header . $objData);<br>    <span style=\"color:blue\">return</span>;<br>}<br></pre>\r\n</div>\r\n<p><br>See modified files in attachment.<br> <br> <strong>4.</strong><br> Run the <span style=\"font-family:Courier New\">index.php</span> script to produce <span style=\"font-family:Courier New\">write.xls</span> (attached)<br> <br> <strong>5.</strong><br> The result of <span style=\"font-family:Courier New\">write.xls</span> is a workbook created by PHPExcel, but using binary data from Perl's Spreadsheet::ExcelWriter<br> <br> <strong>6.</strong><br> When I open the file write.xls it looks ok (one image) in MS Office Excel 2007. Now how does it look in Excel 97? Can you tell us?<br> <br> <strong>7.</strong><br> If it opens <strong>ok</strong> in Excel 97, then we know that the error must be in one of the records <span style=\"font-family:Courier New\">MSODRAWINGGROUP</span>, <span style=\"font-family:Courier New\">MSODRWAING</span>, or <span style=\"font-family:Courier New\">OBJ</span>. It should then be possible to find the problem by editing <span style=\"font-family:Courier New\">MsoDrawingGroup.bin</span>, <span style=\"font-family:Courier New\">MsoDrawing.bin</span>, and <span style=\"font-family:Courier New\">Obj.bin</span> in a HEX editor and run the test again until the error is isolated.<br> <br> If it opens <strong>not ok</strong> in Excel 97, then the error must be some entirely different place.</p>",
    "PostedDate": "2009-10-16T15:00:41.61-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "247270",
    "ThreadId": "71551",
    "Html": "<blockquote style=\"border:solid .1em #ccc;font-style:italic;margin:.25em 1em 0 1em;padding:0 .25em 0 .25em\"><strong>koyama wrote:</strong><br>\r\n<p>Based on your <span style=\"font-family:Courier New\">perl.xls</span> I have uploaded some files that should help locate the error.</p>\r\n<p><a href=\"http://phpexcel.codeplex.com/Project/Download/AttachmentDownload.ashx?ProjectName=PHPExcel&WorkItemId=10749&FileAttachmentId=3447\">excel97-images.zip</a></p>\r\n<p><strong>7.</strong><br> If it opens <strong>ok</strong> in Excel 97, then we know that the error must be in one of the records <span style=\"font-family:Courier New\">MSODRAWINGGROUP</span>, <span style=\"font-family:Courier New\">MSODRWAING</span>, or <span style=\"font-family:Courier New\">OBJ</span>. It should then be possible to find the problem by editing <span style=\"font-family:Courier New\">MsoDrawingGroup.bin</span>, <span style=\"font-family:Courier New\">MsoDrawing.bin</span>, and <span style=\"font-family:Courier New\">Obj.bin</span> in a HEX editor and run the test again until the error is isolated.</p>\r\n</blockquote>\r\n<p>Okay, this is definite progress. The generated file works in Excel 97. I think I neglected to look at the other records, MSDRAWING and OBJ. I focussed all of my efforts on MSODRAWINGGROUP, and I wasn't able to find the source of error there. I'm going to try looking at the other two records to see if I can pinpoint the source of the problem.</p>",
    "PostedDate": "2009-10-19T06:58:52.957-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "247315",
    "ThreadId": "71551",
    "Html": "<p>I diffed Worksheet.php with revision 1.7.0 from 2009-08-10, and I discovered several more changes than the ones you described above. Is there a place to checkout the latest source tree to make sure that none of those extra changes are the source of the fix either?</p>",
    "PostedDate": "2009-10-19T08:44:46.3-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "247339",
    "ThreadId": "71551",
    "Html": "<p><a href=\"http://phpexcel.codeplex.com/SourceControl/ListDownloadableCommits.aspx\">http://phpexcel.codeplex.com/SourceControl/ListDownloadableCommits.aspx</a></p>",
    "PostedDate": "2009-10-19T09:35:10.463-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "247343",
    "ThreadId": "71551",
    "Html": "<p>Is there something I can feed to an svn checkout command? It's nicer to be able to look at revisions with my local tools than a web client.</p>",
    "PostedDate": "2009-10-19T09:37:28.857-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "247505",
    "ThreadId": "71551",
    "Html": "<p>You should be able to check out SVN with this URL together with your username and password here at CodePlex.</p>\r\n<p><a href=\"https://phpexcel.svn.codeplex.com/svn/\">https://phpexcel.svn.codeplex.com/svn/</a></p>\r\n<p>&nbsp;</p>",
    "PostedDate": "2009-10-19T18:02:23.4-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "247870",
    "ThreadId": "71551",
    "Html": "<p>Thanks for your help. I checked out the code, and it's much more convenient. I hope that I can soon submit a patch to fix this.</p>\r\n<p>I scrutinised the OBJ and MSODRAWING records. Between Perl and PHP, I found that Perl only adds\r\n<pre>    # Add ftCf (Clipboard format) subobject\r\n    $sub_record     = 0x0007;   # ftCf\r\n    $sub_length     = 0x0002;\r\n    $sub_data       = pack 'v',      0xFFFF;\r\n    $data          .= pack 'vv',     $sub_record, $sub_length;\r\n    $data          .= $sub_data;\r\n\r\n    # Add ftPioGrbit (Picture option flags) subobject\r\n    $sub_record     = 0x0008;   # ftPioGrbit\r\n    $sub_length     = 0x0002;\r\n    $sub_data       = pack 'v',      0x0001;\r\n    $data          .= pack 'vv',     $sub_record, $sub_length;\r\n    $data          .= $sub_data;\r\n</pre>\r\n</p>\r\n<p>in the OBJ record. In the MSODRAWING record, the only difference is that one of the Sp (shapes) gets more options in the OPT record the Perl code. It gets two more: Fill Style -&gt; fNoFillHitTest and&nbsp; Group Shape -&gt; fPrint.</p>\r\n<p>I'm going to try next if changing just one of the three records at a time (between OBJ, MSODRAWING, and MSODRAWING group) will make this work in Excel 97. I hope the issue isn't a complex interplay between all three records. :-/</p>",
    "PostedDate": "2009-10-20T14:01:16.36-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "247873",
    "ThreadId": "71551",
    "Html": "<p>Thanks for the update, it sounds like you are on the right track. Please keep us updated, it would be great if this can be fixed!</p>",
    "PostedDate": "2009-10-20T14:06:52.607-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "248194",
    "ThreadId": "71551",
    "Html": "<p>I found the bug. Someone typoed in the PHP code. Patch attached. Where it should have been 0x0A00 was instead 0xA000 in PHPExcel in a Sp bitfield. I think it's a bitfield. As far as I can tell, it's two magic bytes attached at the end records of type 0xF00A which according to Microsoft's published standard SHOULD NOT EXIST. Probably undocumented magic numbers that were reverse engineered. Tested on Excel 97, and it works.</p>\r\n<p>Thank you for your help finding this. If you wish to credit my minor patch, my full name is Jordi Guti&eacute;rrez Hermoso.</p>",
    "PostedDate": "2009-10-21T09:40:47.44-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "248691",
    "ThreadId": "71551",
    "Html": "<p>How fantastic! I know how hard it can be to track down errors like this.</p>\r\n<p>I applied your patch and you have been credited in the changelog.</p>\r\n<p><a href=\"http://phpexcel.codeplex.com/WorkItem/View.aspx?WorkItemId=10817\">http://phpexcel.codeplex.com/WorkItem/View.aspx?WorkItemId=10817</a></p>\r\n<p>Thank you for your very hard work debugging this.</p>",
    "PostedDate": "2009-10-22T11:00:15.857-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  }
]