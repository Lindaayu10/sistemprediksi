[
  {
    "Id": "650478",
    "ThreadId": "267281",
    "Html": "\r\n<p>Using PHPExcel 1.7.6 on PHP 5.2.14 on Debian 4.0.</p>\r\n<p>My code is pretty straightforward. I loop through a MySQL DB and populate a 2-d worksheet, doing minimal formatting (posted below). Each worksheet is appended to a larger workbook. For smaller datasets PHPExcel is able to process the data. Here is an example\r\n of some the output from my test tool; parsing the output should be pretty easy. The first line tells you how many datasets from the DB are going to be processed. The next two lines are per worksheet. If it finishes successfully it gives you total time &#43; total\r\n memory used.</p>\r\n<pre>[03:42:30] numSurveys: 6 \r\n[03:42:34] time:  4s memoryUsed: 15.73MB\r\n[03:42:34] dimensions: A1:AE883\r\n[03:42:38] time:  8s memoryUsed: 25.73MB\r\n[03:42:38] dimensions: A1:AC810\r\n[03:42:43] time: 13s memoryUsed: 32.32MB\r\n[03:42:43] dimensions: A1:U787\r\n[03:42:49] time: 19s memoryUsed: 38.70MB\r\n[03:42:49] dimensions: A1:U734\r\n[03:42:55] time: 25s memoryUsed: 46.35MB\r\n[03:42:55] dimensions: A1:AA633\r\n[03:43:02] time: 32s memoryUsed: 52.94MB\r\n[03:43:02] dimensions: A1:U748\r\n[03:43:02] Finished data loop\r\n[03:43:02] Created docWriter\r\n[03:43:02] Saving file@/source/epwbst/content/temporary/LACOE___LACEF_export_2011-08-01_03-42.xls\r\n[03:43:02] Saved file\r\n[03:43:25] total time: 55s total memory: 62.30MB\r\n\r\n[03:55:21] numSurveys: 6 \r\n[03:55:34] time: 13s memoryUsed: 42.74MB\r\n[03:55:34] dimensions: A1:U2772\r\n[03:55:51] time: 30s memoryUsed: 77.82MB\r\n[03:55:51] dimensions: A1:Y2681\r\n[03:56:05] time: 44s memoryUsed: 95.47MB\r\n[03:56:05] dimensions: A1:U2295\r\n[03:56:21] time: 60s memoryUsed: 115.24MB\r\n[03:56:21] dimensions: A1:U2230\r\n[03:56:39] time: 78s memoryUsed: 134.17MB\r\n[03:56:39] dimensions: A1:U2113\r\n[03:56:59] time: 98s memoryUsed: 160.96MB\r\n[03:56:59] dimensions: A1:AA2151\r\n[03:56:59] Finished data loop\r\n[03:56:59] Created docWriter\r\n[03:56:59] Saving file@/source/epwbst/content/temporary/I_CAN_West_Coast_export_2011-08-01_03-55.xls</pre>\r\n<p>The big difference is, for the larger data set, the file never gets saved. The Writer object gets created but I don't know how to debug it because asking PHP to print_r it, kills the process. Is this a bug? Or does this mean I need to allocate more memory.\r\n Memory is at a premium for us, but time is not. I've been trying the other cell caching methods but the only that works is cache_in_memory_serialized. The other configurations just cause my PHP script to die.</p>\r\n<p>&nbsp;</p>\r\n<p></p>\r\n<div style=\"color:black; background-color:white\">\r\n<pre>    <span style=\"color:blue\">public</span> <span style=\"color:blue\">function</span> exportAllSurveys(&amp;$surveyObj, $filePath, $agencyID=SRV_EXPORT_ALL_AGENCIES, \r\n                                     $includeAnon=true, $sortBy=<span style=\"color:#a31515\">''</span>)\r\n    {\t\r\n      $this-&gt;_clearError();\r\n      \r\n      $surveyIndices = $this-&gt;getSurveyIndices($surveyObj);\r\n      $numSurveys = count($surveyIndices);\r\n\r\n      <span style=\"color:green\">//$cacheMethod = PHPExcel_CachedObjectStorageFactory::cache_in_memory;</span>\r\n      $cacheMethod = PHPExcel_CachedObjectStorageFactory::cache_in_memory_serialized;\r\n      <span style=\"color:green\">// $cacheMethod = PHPExcel_CachedObjectStorageFactory::cache_in_memory_gzip;</span>\r\n      <span style=\"color:green\">//$cacheMethod = PHPExcel_CachedObjectStorageFactory::cache_to_discISAM;</span>\r\n      PHPExcel_Settings::setCacheStorageMethod($cacheMethod);\r\n<span style=\"color:green\">/*\t    \r\n      $cacheMethod = PHPExcel_CachedObjectStorageFactory::cache_to_phpTemp;\r\n      $cacheSettings = array('memoryCacheSize' =&gt;'1MB');\r\n      PHPExcel_Settings::setCacheStorageMethod($cacheMethod, $cacheSettings);\r\n*/</span>\r\n      $exportDoc = <span style=\"color:blue\">new</span> PHPExcel();\r\n\r\n      <span style=\"color:blue\">for</span> ($i = 1; $i &lt;= $numSurveys; $i&#43;&#43;){        \r\n        $surveyData = $this-&gt;_retrieveSurveyData($surveyIndices[$i-1], $agencyID, $includeAnon, $sortBy);\r\n        $exportDoc-&gt;createSheet($i);\r\n        $exportDoc-&gt;setActiveSheetIndex($i);    \r\n        $exportDoc = $this-&gt;_formatSpreadsheet($exportDoc, $surveyData[<span style=\"color:#a31515\">'docData'</span>], $surveyData[<span style=\"color:#a31515\">'docHeader'</span>]);\t    \r\n  \r\n        <span style=\"color:green\">// Rename sheet</span>\r\n        $exportDoc-&gt;getActiveSheet()-&gt;setTitle($surveyObj[$surveyIndices[$i-1]][F_NAME]);\r\n\r\n      } \r\n\r\n        $exportDoc-&gt;setActiveSheetIndex(0);\r\n        $docWriter = PHPExcel_IOFactory::createWriter($exportDoc, <span style=\"color:#a31515\">'Excel5'</span>);\r\n        $docWriter-&gt;save($filePath);\r\n\r\n        <span style=\"color:blue\">return</span> true;\r\n    }\r\n    \r\n    <span style=\"color:green\">/*\r\n        Packages surveyData in a form that PHPExcel likes. If there is no data in the\r\n        data or header arrays, we just print a notice in the first cell of the worksheet.\r\n    */</span>\r\n    <span style=\"color:blue\">private</span> <span style=\"color:blue\">function</span> _formatSpreadsheet(&amp;$dataDoc, $data, $header = <span style=\"color:blue\">array</span>()){        \r\n        <span style=\"color:green\">// Populate Excel doc object. Columns are 0-indexed, rows are 1-indexed.</span>\r\n        $docCol = 0;\r\n        $docRow = 1;\r\n        \r\n        <span style=\"color:blue\">if</span> (count($data) &gt; 0 &amp;&amp; count($header) &gt; 0){\r\n            $activeSheet = $dataDoc-&gt;getActiveSheet();        \r\n            <span style=\"color:green\">// The header rows are formatted as bold, horizontal center.</span>\r\n            <span style=\"color:blue\">if</span> (count($header) &gt; 0){\r\n                <span style=\"color:blue\">foreach</span>($header <span style=\"color:blue\">as</span> $cell){\r\n                    $activeSheet-&gt;getCellByColumnAndRow($docCol, $docRow)-&gt;setValue($cell);\r\n                    $headerCellStyle = $activeSheet-&gt;getStyleByColumnAndRow($docCol, $docRow);\r\n                    $headerCellStyle-&gt;getAlignment()\r\n                                    -&gt;setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);\r\n                    $headerCellStyle-&gt;getFont()\r\n                                    -&gt;setBold(true);\r\n                    $docCol&#43;&#43;;\r\n                }\r\n                $docCol = 0;\r\n                $docRow&#43;&#43;;\r\n            }\r\n            \r\n            <span style=\"color:blue\">foreach</span>($data <span style=\"color:blue\">as</span> $dataRow){\r\n                <span style=\"color:blue\">foreach</span>($dataRow <span style=\"color:blue\">as</span> $dataCell){\r\n                    $activeSheet-&gt;getCellByColumnAndRow($docCol, $docRow)\r\n                                             -&gt;setValue($dataCell);\r\n                    $docCol&#43;&#43;;\r\n                }\r\n                $docCol = 0;\r\n                $docRow&#43;&#43;;\r\n            }\r\n        } <span style=\"color:blue\">else</span> {\r\n            $dataDoc-&gt;getActiveSheet()-&gt;getCellByColumnAndRow($docCol,$docRow)\r\n                                      -&gt;setValue(<span style=\"color:#a31515\">&quot;No data has been entered for this survey.&quot;</span>);\r\n        }\r\n        $activeSheet = $dataDoc-&gt;getActiveSheet();                \r\n        $docHighCol = chr(SRV_SIZE_SSHDR &#43; ord(<span style=\"color:#a31515\">'A'</span>));\r\n        <span style=\"color:blue\">for</span> ($col=<span style=\"color:#a31515\">'A'</span>; $col &lt;= $docHighCol; $col&#43;&#43;){\r\n            $activeSheet-&gt;getColumnDimension($col)-&gt;setAutoSize(true);\r\n        }\r\n\r\n        <span style=\"color:blue\">return</span> $dataDoc;\r\n    }\r\n</pre>\r\n</div>\r\n<p></p>\r\n",
    "PostedDate": "2011-08-01T04:14:44.6-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  }
]