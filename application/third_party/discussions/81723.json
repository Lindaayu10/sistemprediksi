[
  {
    "Id": "280633",
    "ThreadId": "81723",
    "Html": "<p>&nbsp;</p>\r\n<p>Been working on this for awhile.</p>\r\n<p>I am writing grades to a spreadsheet and have all my worksheets created.&nbsp; Now I want to create the last worksheet and create my formula to calculate totals and final grade.</p>\r\n<p>&nbsp;</p>\r\n<p>Here is what it looks like so far.</p>\r\n<p>&nbsp;</p>\r\n<div style=\"color:Black;background-color:White\">\r\n<pre>\r\n$result = $db-&gt;sql_query(<span style=\"color:#A31515\">&quot;SELECT a.Session_ID, b.SOMS_KEY, b.Name_Last, b.Name_First, b.UID, g.Group_Name, a.IRAT_Raw, a.IRAT_Grade, a.GRAT_Raw, a.GRAT_Grade, a.AppEx_Raw, a.AppEx_Grade, s.Session_Detail, s.Session_Name FROM &quot;</span>.$prefix.&quot;_tl_session_grades a\r\nJOIN <span style=\"color:#A31515\">&quot;.$prefix.&quot;</span>_tl_session s ON (a.Session_ID = s.Session_ID)                          \r\nJOIN <span style=\"color:#A31515\">&quot;.$prefix.&quot;</span>_tl_students b ON (a.SOMS_KEY = b.SOMS_KEY)\r\nJOIN <span style=\"color:#A31515\">&quot;.$prefix.&quot;</span>_tl_group_students c ON (a.SOMS_KEY = c.SOMS_KEY)\r\nJOIN <span style=\"color:#A31515\">&quot;.$prefix.&quot;</span>_tl_groups g ON (c.Group_ID = g.Group_ID)\r\nWHERE s.Course_Number = <span style=\"color:#A31515\">'$Course_Number'</span>\r\nAND a.Academic_Year = <span style=\"color:#A31515\">'$query_Year'</span>\r\nGROUP BY a.Session_ID, a.SOMS_KEY  \r\nORDER BY a.Session_ID, b.Name_Last ASC&quot;);\r\n<span style=\"color:Blue\">if</span> (!$result) {\r\n    <span style=\"color:Blue\">echo</span>(<span style=\"color:#A31515\">&quot;&lt;p&gt;Error performing query: &quot;</span> . mysql_error() . <span style=\"color:#A31515\">&quot;&lt;/p&gt;&quot;</span>);\r\n    <span style=\"color:Blue\">exit</span>();   \r\n}    \r\n$session = 0;  \r\n$sheet = 0;\r\n<span style=\"color:Blue\">while</span> ($row = $db-&gt;sql_fetchrow($result)) {\r\n    $SID = (int)$row[<span style=\"color:#A31515\">'Session_ID'</span>];\r\n    <span style=\"color:Blue\">if</span> ($SID != $session) {\r\n        \r\n        $session = $SID;\r\n        $datarow=2;\r\n        <span style=\"color:Blue\">if</span>($sheet) $objPHPExcel-&gt;createSheet();\r\n        \r\n    <span style=\"color:Green\">// Set default font</span>\r\n$objPHPExcel-&gt;getDefaultStyle()-&gt;getFont()-&gt;setName(<span style=\"color:#A31515\">'Arial'</span>);\r\n$objPHPExcel-&gt;getDefaultStyle()-&gt;getFont()-&gt;setSize(12);\r\n\r\n$objPHPExcel-&gt;getActiveSheet()-&gt;getStyle(<span style=\"color:#A31515\">'A1'</span>)-&gt;getAlignment()-&gt;setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);\r\n$objPHPExcel-&gt;getActiveSheet()-&gt;getStyle(<span style=\"color:#A31515\">'B1'</span>)-&gt;getAlignment()-&gt;setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);\r\n$objPHPExcel-&gt;getActiveSheet()-&gt;getStyle(<span style=\"color:#A31515\">'C1'</span>)-&gt;getAlignment()-&gt;setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);\r\n        \r\n        $objPHPExcel-&gt;setActiveSheetIndex($sheet)\r\n        -&gt;setCellValue(<span style=\"color:#A31515\">'A1'</span>, <span style=\"color:#A31515\">'Last Name'</span>)\r\n        -&gt;setCellValue(<span style=\"color:#A31515\">'B1'</span>, <span style=\"color:#A31515\">'First Name'</span>)\r\n        -&gt;setCellValue(<span style=\"color:#A31515\">'C1'</span>, <span style=\"color:#A31515\">'UID'</span>)\r\n        -&gt;setCellValue(<span style=\"color:#A31515\">'D1'</span>, <span style=\"color:#A31515\">'Group'</span>)\r\n        -&gt;setCellValue(<span style=\"color:#A31515\">'E1'</span>, <span style=\"color:#A31515\">'Session'</span>)\r\n        -&gt;setCellValue(<span style=\"color:#A31515\">'F1'</span>, <span style=\"color:#A31515\">'Session Name'</span>)\r\n        -&gt;setCellValue(<span style=\"color:#A31515\">'G1'</span>, <span style=\"color:#A31515\">'Irat'</span>)\r\n        -&gt;setCellValue(<span style=\"color:#A31515\">'H1'</span>, <span style=\"color:#A31515\">'Irat Grade'</span>)\r\n        -&gt;setCellValue(<span style=\"color:#A31515\">'I1'</span>, <span style=\"color:#A31515\">'Grat'</span>)\r\n        -&gt;setCellValue(<span style=\"color:#A31515\">'J1'</span>, <span style=\"color:#A31515\">'Grat Grade'</span>)\r\n        -&gt;setCellValue(<span style=\"color:#A31515\">'K1'</span>, <span style=\"color:#A31515\">'Appex'</span>)\r\n        -&gt;setCellValue(<span style=\"color:#A31515\">'L1'</span>, <span style=\"color:#A31515\">'Appex Grade'</span>);\r\n        $objPHPExcel-&gt;getActiveSheet()-&gt;setTitle($row[<span style=\"color:#A31515\">'Session_Detail'</span>]);\r\n        $sheet++;\r\n    }\r\n    \r\n    <span style=\"color:Green\">// Set default font</span>\r\n<span style=\"color:Green\">//$objPHPExcel-&gt;getDefaultStyle()-&gt;getFont()-&gt;setName('Arial');</span>\r\n<span style=\"color:Green\">//$objPHPExcel-&gt;getDefaultStyle()-&gt;getFont()-&gt;setSize(10);</span>\r\n\r\n<span style=\"color:Green\">//$activeSheet-&gt;getColumnDimension($column++)-&gt;setAutoSize(true);</span>\r\n<span style=\"color:Green\">//$objPHPExcel-&gt;getActiveSheet()-&gt;getColumnDimension('A')-&gt;setAutoSize(true);</span>\r\n\r\n    extract($row);\r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getCell(<span style=\"color:#A31515\">'A'</span>.$datarow)-&gt;setValue($Name_Last);\r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getCell(<span style=\"color:#A31515\">'B'</span>.$datarow)-&gt;setValue($Name_First);\r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getCell(<span style=\"color:#A31515\">'C'</span>.$datarow)-&gt;setValue($UID);\r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getCell(<span style=\"color:#A31515\">'D'</span>.$datarow)-&gt;setValue($Group_Name);\r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getCell(<span style=\"color:#A31515\">'E'</span>.$datarow)-&gt;setValue($Session_Detail);\r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getCell(<span style=\"color:#A31515\">'F'</span>.$datarow)-&gt;setValue($Session_Name);\r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getCell(<span style=\"color:#A31515\">'G'</span>.$datarow)-&gt;setValue($IRAT_Raw);\r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getCell(<span style=\"color:#A31515\">'H'</span>.$datarow)-&gt;setValue($IRAT_Grade / 100);\r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getStyle(<span style=\"color:#A31515\">'H'</span>.$datarow)-&gt;getNumberFormat()-&gt;setFormatCode(<span style=\"color:#A31515\">'0.00%'</span>);    \r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getCell(<span style=\"color:#A31515\">'I'</span>.$datarow)-&gt;setValue($GRAT_Raw);\r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getCell(<span style=\"color:#A31515\">'J'</span>.$datarow)-&gt;setValue($GRAT_Grade / 100);\r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getStyle(<span style=\"color:#A31515\">'J'</span>.$datarow)-&gt;getNumberFormat()-&gt;setFormatCode(<span style=\"color:#A31515\">'0.00%'</span>);    \r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getCell(<span style=\"color:#A31515\">'K'</span>.$datarow)-&gt;setValue($AppEx_Raw);\r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getCell(<span style=\"color:#A31515\">'L'</span>.$datarow)-&gt;setValue($AppEx_Grade / 100);\r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getStyle(<span style=\"color:#A31515\">'L'</span>.$datarow)-&gt;getNumberFormat()-&gt;setFormatCode(<span style=\"color:#A31515\">'0.00%'</span>);        \r\n    \r\n    <span style=\"color:Green\">//Auto size the columns</span>\r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getColumnDimension(<span style=\"color:#A31515\">'A'</span>)-&gt;setAutoSize(true);\r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getColumnDimension(<span style=\"color:#A31515\">'B'</span>)-&gt;setAutoSize(true);\r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getColumnDimension(<span style=\"color:#A31515\">'C'</span>)-&gt;setAutoSize(true);\r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getColumnDimension(<span style=\"color:#A31515\">'D'</span>)-&gt;setAutoSize(true);\r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getColumnDimension(<span style=\"color:#A31515\">'E'</span>)-&gt;setAutoSize(true);\r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getColumnDimension(<span style=\"color:#A31515\">'F'</span>)-&gt;setAutoSize(true);\r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getColumnDimension(<span style=\"color:#A31515\">'G'</span>)-&gt;setAutoSize(true);\r\n    \r\n    <span style=\"color:Green\">//Align the columns centered.</span>\r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getStyle(<span style=\"color:#A31515\">'G'</span>.$datarow)-&gt;getAlignment()-&gt;setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);\r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getStyle(<span style=\"color:#A31515\">'H'</span>.$datarow)-&gt;getAlignment()-&gt;setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);\r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getStyle(<span style=\"color:#A31515\">'I'</span>.$datarow)-&gt;getAlignment()-&gt;setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);\r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getStyle(<span style=\"color:#A31515\">'J'</span>.$datarow)-&gt;getAlignment()-&gt;setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);\r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getStyle(<span style=\"color:#A31515\">'K'</span>.$datarow)-&gt;getAlignment()-&gt;setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);\r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getStyle(<span style=\"color:#A31515\">'L'</span>.$datarow)-&gt;getAlignment()-&gt;setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_CENTER);\r\n    $datarow++;\r\n }\r\n\r\n<span style=\"color:Green\">// Set active sheet index to the first sheet, so Excel opens this as the first sheet</span>\r\n$objPHPExcel-&gt;setActiveSheetIndex(0);    \r\n<span style=\"color:Green\">// Redirect output to a client&rsquo;s web browser (Excel5)</span>\r\nheader(<span style=\"color:#A31515\">'Content-Type: application/vnd.ms-excel'</span>);\r\nheader(<span style=\"color:#A31515\">'Content-Disposition: attachment;filename=&quot;01simple.xls&quot;'</span>);\r\nheader(<span style=\"color:#A31515\">'Cache-Control: max-age=0'</span>);\r\n\r\n$objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, <span style=\"color:#A31515\">'Excel5'</span>);\r\n$objWriter-&gt;save(<span style=\"color:#A31515\">'php://output'</span>);\r\n?&gt;\r\n</pre>\r\n</div>\r\n<p>&nbsp;</p>\r\n<p>I want to now create the last worksheet and write totals with a bunch of formulas.&nbsp;&nbsp; I tried to stick this outside my loop and got an error.</p>\r\n<p>&nbsp;</p>\r\n<p><strong>Fatal error</strong>:  Uncaught exception 'Exception' with message 'Active sheet index is out of bounds.'</p>\r\n<p>&nbsp;</p>\r\n<div style=\"color:Black;background-color:White\">\r\n<pre>\r\n<span style=\"color:Green\">//Write totals</span>\r\n $objPHPExcel-&gt;setActiveSheetIndex($sheet)\r\n        -&gt;setCellValue(<span style=\"color:#A31515\">'A1'</span>, <span style=\"color:#A31515\">'Last Name'</span>)\r\n        -&gt;setCellValue(<span style=\"color:#A31515\">'B1'</span>, <span style=\"color:#A31515\">'First Name'</span>)\r\n        -&gt;setCellValue(<span style=\"color:#A31515\">'C1'</span>, <span style=\"color:#A31515\">'UID'</span>)\r\n        -&gt;setCellValue(<span style=\"color:#A31515\">'D1'</span>, <span style=\"color:#A31515\">'Group'</span>)\r\n        -&gt;setCellValue(<span style=\"color:#A31515\">'E1'</span>, <span style=\"color:#A31515\">'IRAT Avg'</span>)\r\n        -&gt;setCellValue(<span style=\"color:#A31515\">'F1'</span>, <span style=\"color:#A31515\">'GRAT Avg'</span>)\r\n        -&gt;setCellValue(<span style=\"color:#A31515\">'G1'</span>, <span style=\"color:#A31515\">'Appex Avg'</span>)\r\n        -&gt;setCellValue(<span style=\"color:#A31515\">'H1'</span>, <span style=\"color:#A31515\">'GRAT/Appex Avg'</span>)\r\n        -&gt;setCellValue(<span style=\"color:#A31515\">'I1'</span>, <span style=\"color:#A31515\">'Multiplier'</span>)\r\n        -&gt;setCellValue(<span style=\"color:#A31515\">'J1'</span>, <span style=\"color:#A31515\">'Group / m'</span>)\r\n        -&gt;setCellValue(<span style=\"color:#A31515\">'K1'</span>, <span style=\"color:#A31515\">'Final TL Grade'</span>);       \r\n        $objPHPExcel-&gt;getActiveSheet()-&gt;setTitle(<span style=\"color:#A31515\">'Totals'</span>);\r\n        \r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getCell(<span style=\"color:#A31515\">'A'</span>.$datarow)-&gt;setValue($Name_Last);\r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getCell(<span style=\"color:#A31515\">'B'</span>.$datarow)-&gt;setValue($Name_First);\r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getCell(<span style=\"color:#A31515\">'C'</span>.$datarow)-&gt;setValue($UID);\r\n    $objPHPExcel-&gt;getActiveSheet()-&gt;getCell(<span style=\"color:#A31515\">'D'</span>.$datarow)-&gt;setValue($Group_Name);\r\n</pre>\r\n</div>\r\n<p>&nbsp;</p>\r\n<p>&nbsp;</p>\r\n<p>&nbsp;</p>",
    "PostedDate": "2010-01-22T08:54:34.497-08:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "280639",
    "ThreadId": "81723",
    "Html": "<p>So it is this line that is causing the fatal error: 'Active sheet index is out of bounds.'<br> <br></p>\r\n<div style=\"color:black;background-color:white\">\r\n<pre>$objPHPExcel-&gt;setActiveSheetIndex($sheet);<br></pre>\r\n</div>\r\n<p><br> That can only mean that <span style=\"font-family:Courier New\">$sheet</span> is too high. For example, if you have 5 sheets in the workbook, you can only set the active index to 0, 1, 2, 3, or 4.<br> <br> Do a check by echoing some numbers immediately before the above line:<br> <br></p>\r\n<div style=\"color:black;background-color:white\">\r\n<pre>var_dump(count($this-&gt;_workSheetCollection));<br>var_dump($sheet);<br>$objPHPExcel-&gt;setActiveSheetIndex($sheet);<br><br></pre>\r\n</div>\r\n<p>The first number is the number of sheets you have so far.<br> The second number is the sheet index (0-based) you are attempting to set as the active one.</p>\r\n<p>What do you get?</p>",
    "PostedDate": "2010-01-22T09:22:49.157-08:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "280644",
    "ThreadId": "81723",
    "Html": "<p><strong>Fatal error</strong>:  Using $this when not in object context</p>",
    "PostedDate": "2010-01-22T09:31:52.777-08:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "280649",
    "ThreadId": "81723",
    "Html": "<p>Sorry, I meant:</p>\r\n<p>\r\n<div style=\"color:Black;background-color:White\">\r\n<pre>var_dump(count($objPHPExcel-&gt;getAllSheets()));\r\nvar_dump($sheet);\r\n$objPHPExcel-&gt;setActiveSheetIndex($sheet);\r\n</pre>\r\n</div>\r\n</p>",
    "PostedDate": "2010-01-22T09:40:24.723-08:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "280689",
    "ThreadId": "81723",
    "Html": "<p>It tells me int(2) int(2)</p>\r\n<p>I have two worksheets I'm trying to write, and a third I'm trying to create at the end to then write totals and compute final grades.&nbsp; Some of these courses will have many more sheets.. one will have 12 that I know of.</p>\r\n<p>&nbsp;</p>",
    "PostedDate": "2010-01-22T10:57:25.137-08:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "280699",
    "ThreadId": "81723",
    "Html": "<p>I wasn't creating the sheet.</p>\r\n<p>&nbsp;</p>\r\n<p>$num_ws = count($objPHPExcel-&gt;getAllSheets()); <br>if($num_ws) $objPHPExcel-&gt;createSheet();</p>\r\n<p>&nbsp;</p>\r\n<p>&nbsp;</p>\r\n<p>DOH!!!</p>",
    "PostedDate": "2010-01-22T11:21:59.043-08:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  }
]