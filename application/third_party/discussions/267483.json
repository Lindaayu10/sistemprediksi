[
  {
    "Id": "651286",
    "ThreadId": "267483",
    "Html": "<p>Hi,</p>\n<p>Im trying to make a script that reads an Excel file, identifies its sheets, and salves each sheet in a new Excel file. I made a loop using</p>\n<p>&nbsp;</p>\n<div style=\"color: black; background-color: white;\">\n<pre>$objPHPExcel-&gt;disconnectWorksheets();\n\n<span style=\"color: blue;\">unset</span>($objPHPExcel);\n</pre>\n</div>\n<p>&nbsp;</p>\n<p>that clear memory after each interaction, and loads a new sheet. But, for some reason, this is not working. I've noticed that the use of disconnectWorksheets and unset(object) actually doesn't make any diference in the memory used, and the script still stop  at the same point if I don't use it, showing the&nbsp;<strong>Fatal error</strong>: Allowed memory size of 67108864 bytes exhausted (tried to allocate 262145 bytes).</p>\n<p>&nbsp;</p>\n<p>Here is the detailed code:</p>\n<p>&nbsp;</p>\n<p>&nbsp;</p>\n<div style=\"color: black; background-color: white;\">\n<pre>&lt;?php\n\nerror_reporting(E_ALL);\n\ndate_default_timezone_set(<span style=\"color: #a31515;\">'Europe/London'</span>);\n\n<span style=\"color: green;\">/** PHPExcel_IOFactory */</span>\n<span style=\"color: blue;\">require_once</span> <span style=\"color: #a31515;\">'../Classes/PHPExcel/IOFactory.php'</span>;\n\n<span style=\"color: green;\">//file name</span>\n$inputFileName = <span style=\"color: #a31515;\">'datafile1.xls'</span>;\n\n<span style=\"color: green;\">//identificate filetype</span>\n$inputFileType = <span style=\"color: #a31515;\">'Excel5'</span>;\n\n<span style=\"color: green;\">//Create an object to read the file</span>\n$objReader = PHPExcel_IOFactory::createReader($inputFileType);\n\n<span style=\"color: blue;\">echo</span> date(<span style=\"color: #a31515;\">'H:i:s'</span>) . <span style=\"color: #a31515;\">\" Indexing file... &lt;br&gt;\"</span>;\n\n<span style=\"color: green;\">//Catch sheets names</span>\n$sheets = $objReader-&gt;listWorksheetNames($inputFileName);\n$n_of_sheets = count($sheets);\n\n<span style=\"color: green;\">//echo info about the sheets</span>\n<span style=\"color: blue;\">echo</span> date(<span style=\"color: #a31515;\">'H:i:s'</span>) . <span style=\"color: #a31515;\">\" File indexed! &lt;br&gt;\"</span>;\n<span style=\"color: blue;\">echo</span> <span style=\"color: #a31515;\">\"File has \"</span>.$n_of_sheets.<span style=\"color: #a31515;\">\" sheets:&lt;br&gt;\"</span>;\n<span style=\"color: blue;\">foreach</span> ($sheets <span style=\"color: blue;\">as</span> $key=&gt;$value):\n\t<span style=\"color: blue;\">echo</span> <span style=\"color: #a31515;\">\"\\t\"</span>.$value.<span style=\"color: #a31515;\">\"&lt;br&gt;\"</span>;\n<span style=\"color: blue;\">endforeach</span>;\n\n\n<span style=\"color: green;\">// Echo memory peak usage</span>\n<span style=\"color: blue;\">echo</span> <span style=\"color: #a31515;\">\"&lt;br&gt;\"</span>.date(<span style=\"color: #a31515;\">'H:i:s'</span>) . <span style=\"color: #a31515;\">\" Peak memory usage: \"</span> . (memory_get_peak_usage(true) / 1024 / 1024) . <span style=\"color: #a31515;\">\" MB\\r\\n\"</span>;\n\n<span style=\"color: green;\">//Can't use it because dates becomes unformatted.</span>\n<span style=\"color: green;\">//$objReader-&gt;setReadDataOnly(true);</span>\n\n<span style=\"color: blue;\">echo</span> <span style=\"color: #a31515;\">\"&lt;br&gt;The script will try to read the sheets separately and save them in separeted files. Working...&lt;br&gt;&lt;br&gt;\"</span>;\n\n<span style=\"color: blue;\">foreach</span> ($sheets <span style=\"color: blue;\">as</span> $key=&gt;$value):\n\t<span style=\"color: green;\">//sheet being imported</span>\n\t$objReader-&gt;setLoadSheetsOnly($value);\n\t\n\t<span style=\"color: blue;\">try</span> {\n\t\t<span style=\"color: green;\">//Load sheet</span>\n\t\t<span style=\"color: blue;\">echo</span> date(<span style=\"color: #a31515;\">'H:i:s'</span>) . <span style=\"color: #a31515;\">\" Loading sheet \"</span>.$value.<span style=\"color: #a31515;\">\"...&lt;br&gt;\"</span>;\n\t\t$objPHPExcel = $objReader-&gt;load($inputFileName);\n\t\t<span style=\"color: blue;\">echo</span> date(<span style=\"color: #a31515;\">'H:i:s'</span>) . <span style=\"color: #a31515;\">\" Sheet \"</span>.$value.<span style=\"color: #a31515;\">\" loaded! &lt;br&gt;\"</span>;\n\t\t\n\t\t<span style=\"color: green;\">//Write the file</span>\n\t\t<span style=\"color: blue;\">echo</span> date(<span style=\"color: #a31515;\">'H:i:s'</span>) . <span style=\"color: #a31515;\">\" Saving sheet on file  \"</span>.str_replace(<span style=\"color: #a31515;\">'.xls'</span>, <span style=\"color: #a31515;\">''</span>, $inputFileName).<span style=\"color: #a31515;\">\"_\"</span>.$value.<span style=\"color: #a31515;\">\".xlsx&lt;br&gt;\"</span>;\n\t\t$objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, <span style=\"color: #a31515;\">'Excel2007'</span>);\n\t\t$savedir=<span style=\"color: blue;\">__DIR__</span>.<span style=\"color: #a31515;\">\"/\"</span>.str_replace(<span style=\"color: #a31515;\">'.xls'</span>, <span style=\"color: #a31515;\">''</span>, $inputFileName).<span style=\"color: #a31515;\">\"_\"</span>.$value.<span style=\"color: #a31515;\">\".xlsx\"</span>;\n\t\t$objWriter-&gt;save($savedir);\n\t\t<span style=\"color: blue;\">echo</span> date(<span style=\"color: #a31515;\">'H:i:s'</span>).<span style=\"color: #a31515;\">\" Sheet \"</span>.$value.<span style=\"color: #a31515;\">\" saved successfully!&lt;br&gt;&lt;br&gt;\"</span>;\n\n\t\t<span style=\"color: green;\">//Clear memory</span>\n\t\t$objPHPExcel-&gt;disconnectWorksheets(); \n   \t\t<span style=\"color: blue;\">unset</span>($objPHPExcel);\n\n   \t\t<span style=\"color: blue;\">echo</span> <span style=\"color: #a31515;\">\"&lt;br&gt;\"</span>.date(<span style=\"color: #a31515;\">'H:i:s'</span>) . <span style=\"color: #a31515;\">\" Peak memory usage: \"</span> . (memory_get_peak_usage(true) / 1024 / 1024) . <span style=\"color: #a31515;\">\" MB\\r\\n\"</span>;\n\t} <span style=\"color: blue;\">catch</span>(Exception $e) {\n\t\t<span style=\"color: blue;\">die</span>(<span style=\"color: #a31515;\">'Error loading file: '</span>.$e-&gt;getMessage());\n\t}\n\t\n<span style=\"color: blue;\">endforeach</span>;\n\n\n\n<span style=\"color: green;\">// Echo memory peak usage</span>\n<span style=\"color: blue;\">echo</span> date(<span style=\"color: #a31515;\">'H:i:s'</span>) . <span style=\"color: #a31515;\">\" Peak memory usage: \"</span> . (memory_get_peak_usage(true) / 1024 / 1024) . <span style=\"color: #a31515;\">\" MB\\r\\n\"</span>;\n\n<span style=\"color: green;\">// Echo done</span>\n<span style=\"color: blue;\">echo</span> date(<span style=\"color: #a31515;\">'H:i:s'</span>) . <span style=\"color: #a31515;\">\" Done writing files.\\r\\n\"</span>;\n\n?&gt;\n</pre>\n</div>\n<p>&nbsp;</p>\n<p>I can't understand why memory isn't being cleared, but also I don't know if I'm using it right or if is really possible to do what I'm trying to. I was thinking about pass the sheets names by $_SESSION and load the php file one time for each sheet, automatically  one after other, so it divides memory consumption, but I don't know if it works that way.</p>\n<p>Please, help me!</p>",
    "PostedDate": "2011-08-02T11:13:39.703-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "651360",
    "ThreadId": "267483",
    "Html": "<p>I was trying to solve the problem my self, and I found something really strange: I commented the lines that creates and uses the objWriter, to reduces the operations performed. I know that it doesn't make any sense, because now the script just  open a sheet and then the sheet is discarded when I clear up the memory to get more space and read another sheet, but I was just analising the behavior of PHPExcel.&nbsp;</p>\n<p>The strange part, at least for me, is that after I remove the write code, the memory consumption increased instead of decrease. I don't know why. I just commented the lines right under the comment //Write the file.</p>\n<p>&nbsp;</p>\n<p>Every help is welcome. ;D</p>",
    "PostedDate": "2011-08-02T13:23:17.517-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "656453",
    "ThreadId": "267483",
    "Html": "<p>I am having exactly the same issue.</p>\r\n<p>I only need to read the file, so I'm using the chunkFilter to save on memory, after each chunk I'm trying to disconnecWorksheets, and unset($objPHPExcel) but this does not seem to affect the memory usage in the slightest, meaning I end up with the same number of rows read, as I would if I was just reading the whole file. This seems like a bug of some sort. if anyone knows what might be up, please let me know :)</p>\r\n<p>I've also tried&nbsp;<span style=\"font-family: monospace; white-space: pre;\"><span class=\"pln\">gc_collect_cycles</span><span class=\"pun\">(); to force garbage collection, but it's not helping :(</span></span></p>",
    "PostedDate": "2011-08-11T04:31:38.683-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  }
]