[
  {
    "Id": "1284838",
    "ThreadId": "558465",
    "Html": "Hi,\r<br />\n<br />\nI need to extract information from a Excel spreadsheet, including background colour, font colour, border and content.\r<br />\n<br />\nThe file is around 5 or 6 Meg.\r<br />\n<br />\nThis is my code:<br />\n<pre><code> $storagename=$_SERVER[&quot;DOCUMENT_ROOT&quot;].'/spreadsheets/sites/default/files/spread1.xlsx';\n  // This is the file path to be uploaded.\n  if (file_exists($storagename)) {\n    $bgcolor=array();\n    $inputFileType = PHPExcel_IOFactory::identify($storagename);\n    $objReader = PHPExcel_IOFactory::createReader($inputFileType);\n    // Get names of worksheets in the file.\n    $worksheetNames = $objReader-&gt;listWorksheetNames($storagename);\n    // Print worksheet names.\n    foreach ($worksheetNames as $sheetName) {\n      echo '&lt;h3&gt;'.$sheetName.'&lt;/h3&gt;';\n      \n      $objReader = PHPExcel_IOFactory::createReader('Excel2007');\n      $objReader-&gt;setLoadSheetsOnly($sheetName);\n      $objPHPExcel = $objReader-&gt;load($storagename);\n      $objWorksheet = $objPHPExcel-&gt;getActiveSheet();\n      $rownumber=0;\n      foreach ($objWorksheet-&gt;getRowIterator() as $row){\n        $cellIterator = $row-&gt;getCellIterator();\n        $rownumber++;\n        $colwidths=array();\n        foreach ($cellIterator as $cell) {\n          $cellcolumn=$cell-&gt;getColumn();\n          $cellindex=PHPExcel_Cell::columnIndexFromString($cellcolumn);\n          if (!array_key_exists($cellcolumn,$colwidths)) {\n            $colwidths[$cellcolumn]= $objPHPExcel-&gt;getActiveSheet()-&gt;getColumnDimensionByColumn($cellcolumn)-&gt;getWidth();\n          }\n          echo '; '.$cellcolumn.$rownumber.'='.$colwidths[$cellcolumn].', #'.$bgcolor[$cellindex.'_'.$rownumber];\n        }\n        echo '&lt;hr/&gt;';\n      }\n    }\n  }else {\n    die('File not found.&lt;hr/&gt;');\n  }</code></pre>\n\nThe spreadsheet has the following sheet names:\r<br />\n&quot;Definitions&quot;, &quot;SAQA&quot;, &quot;DPSA&quot;, &quot;PSETA&quot;, &quot;PALAMA&quot;, &quot;FASSET&quot;, &quot;QCTO&quot;, &quot;CHE (Summary)&quot;\r<br />\n<br />\nThe first sheet has 17 columns and 40 rows.\r<br />\nThe second sheet has 26 columns and 64 rows.\r<br />\nThe third sheet has 6 columns and 39 rows.\r<br />\n<br />\nThe first two sheets are processed correctly.\r<br />\nThe sheetnames &quot;Definitions&quot; and &quot;SAQA&quot; are echoed as expected. However, my /var/log/apache2/error.log file has the following error: \r<br />\n<br />\nPHP Fatal error:  Allowed memory size of 134217728 bytes exhausted (tried to allocate 88 bytes) in /var/www/spreadsheets/sites/all/libs/Classes/PHPExcel/Style.php on line 120.\r<br />\n<br />\nI've researched the error and I believe that the way to address this is to read a few lines at a time.\r<br />\n<br />\nHowever, the spreadsheet worksheets don't seem to be overly large.\r<br />\n<br />\nShould I be looking elsewhere?<br />\n",
    "PostedDate": "2014-08-04T10:13:04.083-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "1285535",
    "ThreadId": "558465",
    "Html": "Physical size of a file is less relevant than the number of rows and columns, and the number of rows and columns may not always be what you believe, because an empty cell is still a cell.\r<br />\n<br />\nLook at some of the suggestions given in the documentation about memory use, such as cell caching, and also on clearing memory when reading repeatedly in a loop.<br />\n",
    "PostedDate": "2014-08-04T16:45:16.31-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "1286790",
    "ThreadId": "558465",
    "Html": "Hi Mark,\r<br />\n<br />\nThanks for your reply.\r<br />\n<br />\nI've altered my code:<br />\n<pre><code>\n  if (file_exists($storagename)) {\n    $cacheMethod = PHPExcel_CachedObjectStorageFactory::cache_to_discISAM;//&lt;-------------------------Added\n    $cacheSettings = array('dir' =&gt; '/tmp');//&lt;-------------------------Added\n    PHPExcel_Settings::setCacheStorageMethod($cacheMethod, $cacheSettings);//&lt;-------------------------Added\n    $inputFileType = PHPExcel_IOFactory::identify($storagename);\n    $objReader = PHPExcel_IOFactory::createReader($inputFileType);\n    $worksheetNames = $objReader-&gt;listWorksheetNames($storagename);\n    foreach ($worksheetNames as $sheetName) {\n      echo '&lt;h3&gt;'.$sheetName.'&lt;/h3&gt;';\n      $objReader = PHPExcel_IOFactory::createReader($inputFileType);\n      $objReader-&gt;setLoadSheetsOnly($sheetName);\n      $objPHPExcel = $objReader-&gt;load($storagename);\n      $objWorksheet = $objPHPExcel-&gt;getActiveSheet();\n      PHPExcel_CachedObjectStorageFactory::cache_to_discISAM;\n      $rownumber=0;\n      foreach ($objWorksheet-&gt;getRowIterator() as $row){\n        $cellIterator = $row-&gt;getCellIterator();\n        $rownumber++;\n        $colwidths=array();\n        foreach ($cellIterator as $cell) {\n          $cellcolumn=$cell-&gt;getColumn();\n          $cellindex=PHPExcel_Cell::columnIndexFromString($cellcolumn);\n          if (!array_key_exists($cellcolumn,$colwidths)) {\n            $colwidths[$cellcolumn]= $objPHPExcel-&gt;getActiveSheet()-&gt;getColumnDimensionByColumn($cellcolumn)-&gt;getWidth();\n          }\n          $bgcolor=$cell-&gt;getStyle()-&gt;getFill()-&gt;getStartColor()-&gt;getRGB();\n          echo '; '.$cellcolumn.$rownumber.'='.$colwidths[$cellcolumn].', #'.$bgcolor;\n        }\n        echo '&lt;hr/&gt;';\n      }\n      $objPHPExcel-&gt;disconnectWorksheets();//&lt;-------------------------Added\n      unset($objPHPExcel);//&lt;-------------------------Added\n    }\n  }else {\n    die('File not found.&lt;hr/&gt;');\n  }</code></pre>\n\nThe second sheetname is echoed, but the script halts before the second sheet is traversed.\r<br />\n<br />\nThe error in <strong>/var/log/apache2/error.log</strong> is:\r<br />\n<br />\n<strong>[error] [client 127.0.0.1] PHP Fatal error:  Allowed memory size of 134217728 bytes exhausted (tried to allocate 32 bytes) in /var/www/spreadsheets/sites/all/libs/Classes/PHPExcel/Style/Borders.php on line 137</strong>\r<br />\n<br />\nThanks for your assistance.\r<br />\n<br />\n~ Dave<br />\n",
    "PostedDate": "2014-08-06T00:30:02.533-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  }
]