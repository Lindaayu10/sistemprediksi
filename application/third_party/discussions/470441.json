[
  {
    "Id": "1126492",
    "ThreadId": "470441",
    "Html": "I could use some help. I have been working on a script for awhile now to export some data from SQL to Excel.  I have a db that looks like below that has users and what departments they are in. Some user are in multiple departments. The script I have worked on so far will export the data fine from SQL and create the worksheets but only writes the data on the last sheet.  I need it to create a sheet for every user and then put that users information on that sheet.  So for an example it would create a sheet called Smith_Joe and then add the information that pertains to Smith_Joe.  Here is what my db info looks like.<br />\n<pre><code>TeamName      UserID     Deparment     Description\n---------------------------------------------------\nSmith_Joe    JOE4S       52200          Sales\nSmith_Joe    JOE4S       53002          Budget\nSmith_Joe    JOE4S       43302          Dev\nBlack_BJ     BJ3OO       43332          Mrkt\nSteh_Tray    ST44S       65573          Prod\nSteh_Tray    ST44S       52200          Sales\n</code></pre>\n\nThis is the code I have so far.<br />\n<pre><code>&lt;?php \n    session_start();\n    $userid = $_SESSION['userid'];\n\n\n            $serverName = &quot;sqlserver, 1433&quot;;\n    $connectionInfo = array(&quot;UID&quot;=&gt;&quot;userid&quot;, &quot;PWD&quot;=&gt;&quot;password&quot;, &quot;Database&quot;=&gt;&quot;database&quot;);\n    $conn = sqlsrv_connect( $serverName, $connectionInfo);\n    if( $conn === false )\n    {\n         echo &quot;Could not connect.\\n&quot;;\n         die( print_r( sqlsrv_errors(), true));\n    }\n\n\n        require_once 'Classes/PHPExcel.php';\n    include 'Classes/PHPExcel/Writer/Excel2007.php';\n\n\n\n\n    // Create new PHPExcel object\n    $objPHPExcel = new PHPExcel();\n\n    // Set document properties\n    $objPHPExcel-&gt;getProperties()-&gt;setCreator(&quot;Budget SYstem&quot;)\n     -&gt;setLastModifiedBy(&quot;System&quot;)\n     -&gt;setTitle(&quot;System&quot;)\n     -&gt;setSubject(&quot;System Security&quot;)\n     -&gt;setDescription(&quot;System Security Report&quot;)\n     -&gt;setKeywords(&quot;office 2007&quot;)\n     -&gt;setCategory(&quot;Security&quot;);\n\n    // Create the worksheet\n    $objPHPExcel-&gt;setActiveSheetIndex(0);\n\n    $objPHPExcel-&gt;getActiveSheet()-&gt;setCellValue('A1', &quot;TeamName&quot;)\n     -&gt;setCellValue('B1', &quot;UserID&quot;)\n     -&gt;setCellValue('C1', &quot;Departments&quot;)\n     -&gt;setCellValue('D1', &quot;Description&quot;);\n\n\n\n    /* Set up and execute the query. */\n    $tsql = &quot;SELECT MemberOfTeamID AS 'TeamName', SUBSTRING(UserID, CHARINDEX('\\', UserID)+1, 250) AS 'UserID', Left(ProfileID, PatIndex('%[^0-9,.,-+-,^a-z]%', ProfileID)) AS 'Departments',SUBSTRING(ProfileID, PatIndex('%[^0-9,.,-+-]%', ProfileID), 8000) AS Description FROM UserProfile u INNER JOIN UserTeamAssign ut ON u.UserID = ut.UserorTeamID WHERE UserID LIKE '%$UsedrID%' AND u.ProfileID != 'Planners' AND u.ProfileID &lt;&gt; '00 Access_All_Models' AND u.ProfileID &lt;&gt; '00 Required for Global Rates' AND MemberOfTeamID &lt;&gt; 'AdminTeam'&quot;;\n\n\n    $stmt = sqlsrv_query( $conn, $tsql);\n\n    $dataArray= array();\n\n    $uid = $row['UserID'];\n\n    while($row = sqlsrv_fetch_array($stmt, SQLSRV_FETCH_ASSOC)){\n\n     if ($row['UserID'] != $uid){\n\n     $objWorksheet = new PHPExcel_Worksheet($objPHPExcel);\n    $objPHPExcel-&gt;addSheet($objWorksheet);\n    $objWorksheet-&gt;setTitle(''. $row['TeamName']);\n   \n    $row_array['TeamName'] = $row['TeamName'];\n    $row_array['UserID'] = $row['UserID'];\n    $row_array['Departments'] = $row['Departments'];\n    $row_array['Description'] = $row['Description'];\n   array_push($dataArray,$row_array);\n\n   } \n\n\n   $row_array['TeamName'] = $row['TeamName'];\n   $row_array['UserID'] = $row['UserID'];\n   $row_array['Departments'] = $row['Departments'];\n   $row_array['Description'] = $row['Description'];\n\n   array_push($dataArray,$row_array);\n   $uid = $row['UserID'];\n\n   }\n\n    $objPHPExcel-&gt;getActiveSheet()-&gt;fromArray($dataArray, NULL, 'A2');\n\n    // Save Excel 2007 file\n    #echo date('H:i:s') . &quot; Write to Excel2007 format\\n&quot;;\n    $objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel2007');\n    ob_end_clean();\n    // We'll be outputting an excel file\n    header('Content-type: application/vnd.ms-excel');\n    // It will be called file.xls\n    header('Content-Disposition: attachment; filename=&quot;security.xlsx&quot;');\n    $objWriter-&gt;save('php://output');\n    Exit;\n\n\n        /* Free statement and connection resources. */\n    sqlsrv_free_stmt( $stmt);\n    sqlsrv_close( $conn);  ?&gt;</code></pre>\n\n",
    "PostedDate": "2013-11-19T05:05:33.017-08:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "1127536",
    "ThreadId": "470441",
    "Html": "Anyone have an idea on how to get this to work or maybe another way to do it. Basically I have a SQL db with this kind of information in it.<br />\n<pre><code>TeamName      UserID     Deparment     Description\n---------------------------------------------------\nSmith_Joe    JOE4S       52200          Sales\nSmith_Joe    JOE4S       53002          Budget\nSmith_Joe    JOE4S       43302          Dev\nBlack_BJ     BJ3OO       43332          Mrkt\nSteh_Tray    ST44S       65573          Prod\nSteh_Tray    ST44S       52200          Sales</code></pre>\n\nI need it to create a workbook with sheet name named after the user which is the TeamName column.  So I would have a workbook and it would look like.\r<br />\n<br />\n<strong>Sheet1 (Named Smith_Joe)</strong>\r<br />\nSmith_Joe    JOE4S       52200          Sales\r<br />\nSmith_Joe    JOE4S       53002          Budget\r<br />\nSmith_Joe    JOE4S       43302          Dev\r<br />\n<br />\n<strong>Sheet2 (Named Black_BJ)</strong>\r<br />\nBlack_BJ     BJ3OO       43332          Mrkt\r<br />\n<br />\n<strong>Sheet3 (Named Steh_Tray)</strong>\r<br />\nSteh_Tray    ST44S       65573          Prod\r<br />\nSteh_Tray    ST44S       52200          Sales\r<br />\n<br />\nand so on to the next user and so on...\r<br />\n<br />\nAny help would be great, thanks!!<br />\n",
    "PostedDate": "2013-11-21T06:08:29.833-08:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "1127543",
    "ThreadId": "470441",
    "Html": "You must use fromArray when you shoot a user switching, before to create the new worksheet, empty the array before storing the first record of the new user.\r<br />\nDo not forget to include data for the last user in loop-out, of course.\r<br />\n<br />\nNote: the header sent corresponds to an xls file, free_stmt, close are never run (this is after Exit)<br />\n",
    "PostedDate": "2013-11-21T06:21:56.487-08:00",
    "UserRole": null,
    "MarkedAsAnswerDate": "2013-11-27T09:42:18.33-08:00"
  }
]