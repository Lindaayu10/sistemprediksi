[
  {
    "Id": "221850",
    "ThreadId": "65145",
    "Html": "<p>I've managed to get my hack of the phppgadmin dataimport script to work</p>\r\n<p>&nbsp;</p>\r\n<p>This will insert your records into the proper columns regardless of column order</p>\r\n<p>Some of the loops could probably be tightened up, but it works.</p>\r\n<p>I don't use nulls in my table at all so any empty cell is replaced with an empty string.. easy enough to change if you want to use nulls I guess</p>\r\n<p>&nbsp;</p>\r\n<p>Any feedback is welcome</p>\r\n<p>You need to edit the database information, the table to insert into, and the file to open.</p>\r\n<p>&nbsp;</p>\r\n<div style=\"color:Black;background-color:White\">\r\n<pre>&lt;?php \r\n<span style=\"color:Green\">//This is essentially the dataimport script from phppgadmin reworked to use an excel sheet rather than a csv or xml file.</span>\r\nerror_reporting(E_ALL);\r\n\r\n<span style=\"color:Green\">/** PHPExcel_IOFactory */</span>\r\n<span style=\"color:Blue\">require_once</span> <span style=\"color:#A31515\">'./Classes/PHPExcel/IOFactory.php'</span>;\r\n\r\n\r\n<span style=\"color:Blue\">function</span> getdb() {\r\n    $db = pg_connect(<span style=\"color:#A31515\">&quot;YOUR DB INFO&quot;</span>) <span style=\"color:Blue\">or</span> <span style=\"color:Blue\">die</span>(<span style=\"color:#A31515\">'connection failed'</span>);\r\n    <span style=\"color:Blue\">return</span> $db;\r\n}\r\n$conn = getdb();\r\n\t\r\n$table= <span style=\"color:#A31515\">'SET TABLE TO INSERT INTO'</span>;\r\n\r\n<span style=\"color:Green\">//Load XLS file and </span>\r\n$objPHPExcel = PHPExcel_IOFactory::load(<span style=\"color:#A31515\">&quot;XLS FILE&quot;</span>);\r\n\r\n$objPHPExcel-&gt;setActiveSheetIndex(0);\r\n$objWorksheet = $objPHPExcel-&gt;getActiveSheet();\r\n\r\n$highestRow = $objWorksheet-&gt;getHighestRow();\r\n$highestColumn = $objWorksheet-&gt;getHighestColumn();\r\n$highestColumnIndex = PHPExcel_Cell::columnIndexFromString($highestColumn);\r\n\r\n<span style=\"color:Green\">//These functions are from phppgadmin \t</span>\r\n<span style=\"color:Blue\">function</span> fieldClean(&amp;$str) {\r\n\t\t<span style=\"color:Blue\">if</span> ($str === null) <span style=\"color:Blue\">return</span> null;\r\n\t\t$str = str_replace(<span style=\"color:#A31515\">'&quot;'</span>, <span style=\"color:#A31515\">'&quot;&quot;'</span>, $str);\r\n\t\t<span style=\"color:Blue\">return</span> $str;\r\n\t}\r\n\t<span style=\"color:Blue\">function</span> schema() {\r\n\t\t<span style=\"color:Blue\">return</span> <span style=\"color:#A31515\">''</span>;\r\n\t}\r\n\t\r\n\t<span style=\"color:Green\">//I'm not using this function properly-- not sure what $allowednulls should be</span>\r\n$allowednulls = '\\\\'; \r\n\t<span style=\"color:Blue\">function</span> loadNULLArray() {\r\n\t\t$<span style=\"color:Blue\">array</span> = <span style=\"color:Blue\">array</span>();\r\n\t\t<span style=\"color:Blue\">if</span> (<span style=\"color:Blue\">isset</span>($allowednulls)) {\r\n\t\t\t<span style=\"color:Blue\">foreach</span> ($allowednulls <span style=\"color:Blue\">as</span> $null_char)\r\n\t\t\t\t$<span style=\"color:Blue\">array</span>[] = $null_char;\r\n\t\t}\r\n\t\t<span style=\"color:Blue\">return</span> $<span style=\"color:Blue\">array</span>;\r\n\t}\r\n\t\t<span style=\"color:Blue\">function</span> determineNull($field, $null_array) {\r\n\t\t<span style=\"color:Blue\">return</span> in_array($field, $null_array);\r\n\t}\r\n<span style=\"color:Blue\">function</span> clean(&amp;$str) {\r\n\t\t<span style=\"color:Blue\">if</span> ($str === null) <span style=\"color:Blue\">return</span> null;\r\n\t\t$str = str_replace(<span style=\"color:#A31515\">&quot;\\r\\n&quot;</span>,<span style=\"color:#A31515\">&quot;\\n&quot;</span>,$str);\r\n\t\t<span style=\"color:Blue\">if</span> (function_exists(<span style=\"color:#A31515\">'pg_escape_string'</span>))\r\n\t\t\t$str = pg_escape_string($str);\r\n\t\t<span style=\"color:Blue\">else</span>\r\n\t\t\t$str = addslashes($str);\r\n\t\t<span style=\"color:Blue\">return</span> $str;\r\n\t}\r\n$null_array= loadnullarray();\r\n\r\n\t<span style=\"color:Blue\">function</span> formatValue($type, $format, $value) {\r\n\t\t<span style=\"color:Blue\">switch</span> ($type) {\r\n\t\t\t<span style=\"color:Blue\">case</span> <span style=\"color:#A31515\">'bool'</span>:\r\n\t\t\t<span style=\"color:Blue\">case</span> <span style=\"color:#A31515\">'boolean'</span>:\r\n\t\t\t\t<span style=\"color:Blue\">if</span> ($value == <span style=\"color:#A31515\">'t'</span>)\r\n\t\t\t\t\t<span style=\"color:Blue\">return</span> <span style=\"color:#A31515\">'TRUE'</span>;\r\n\t\t\t\t<span style=\"color:Blue\">elseif</span> ($value == <span style=\"color:#A31515\">'f'</span>)\r\n\t\t\t\t\t<span style=\"color:Blue\">return</span> <span style=\"color:#A31515\">'FALSE'</span>;\r\n\t\t\t\t<span style=\"color:Blue\">elseif</span> ($value == <span style=\"color:#A31515\">''</span>)\r\n\t\t\t\t\t<span style=\"color:Blue\">return</span> <span style=\"color:#A31515\">'NULL'</span>;\r\n\t\t\t\t<span style=\"color:Blue\">else</span>\r\n\t\t\t\t\t<span style=\"color:Blue\">return</span> $value;\r\n\t\t\t\t<span style=\"color:Blue\">break</span>;\r\n\t\t\t<span style=\"color:Blue\">default</span>:\r\n\t\t\t\t<span style=\"color:Green\">// Checking variable fields is difficult as there might be a size</span>\r\n\t\t\t\t<span style=\"color:Green\">// attribute...</span>\r\n\t\t\t\t<span style=\"color:Blue\">if</span> (strpos($type, <span style=\"color:#A31515\">'time'</span>) === 0) {\r\n\t\t\t\t\t<span style=\"color:Green\">// Assume it's one of the time types...</span>\r\n\t\t\t\t\t<span style=\"color:Blue\">if</span> ($value == <span style=\"color:#A31515\">''</span>) <span style=\"color:Blue\">return</span> <span style=\"color:#A31515\">&quot;''&quot;</span>;\r\n\t\t\t\t\t<span style=\"color:Blue\">elseif</span> (strcasecmp($value, <span style=\"color:#A31515\">'CURRENT_TIMESTAMP'</span>) == 0\r\n\t\t\t\t\t\t\t|| strcasecmp($value, <span style=\"color:#A31515\">'CURRENT_TIME'</span>) == 0\r\n\t\t\t\t\t\t\t|| strcasecmp($value, <span style=\"color:#A31515\">'CURRENT_DATE'</span>) == 0\r\n\t\t\t\t\t\t\t|| strcasecmp($value, <span style=\"color:#A31515\">'LOCALTIME'</span>) == 0\r\n\t\t\t\t\t\t\t|| strcasecmp($value, <span style=\"color:#A31515\">'LOCALTIMESTAMP'</span>) == 0) {\r\n\t\t\t\t\t\t<span style=\"color:Blue\">return</span> $value;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t<span style=\"color:Blue\">elseif</span> ($format == <span style=\"color:#A31515\">'EXPRESSION'</span>)\r\n\t\t\t\t\t\t<span style=\"color:Blue\">return</span> $value;\r\n\t\t\t\t\t<span style=\"color:Blue\">else</span> {\r\n\t\t\t\t\t\tclean($value);\r\n\t\t\t\t\t\t<span style=\"color:Blue\">return</span> <span style=\"color:#A31515\">&quot;'{$value}'&quot;</span>;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t<span style=\"color:Blue\">else</span> {\r\n\t\t\t\t\t<span style=\"color:Blue\">if</span> ($format == <span style=\"color:#A31515\">'VALUE'</span>) {\r\n\t\t\t\t\t\tclean($value);\r\n\t\t\t\t\t\t<span style=\"color:Blue\">return</span> <span style=\"color:#A31515\">&quot;'{$value}'&quot;</span>;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t<span style=\"color:Blue\">return</span> $value;\r\n\t\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n<span style=\"color:Blue\">function</span> insertRow($table, $vars, $nulls, $format, $types) {\r\n\r\n\t\t<span style=\"color:Blue\">if</span> (!is_array($vars) || !is_array($nulls) || !is_array($format)\r\n\t\t\t|| !is_array($types)) <span style=\"color:Blue\">return</span> -1;\r\n\t\t<span style=\"color:Blue\">else</span> {\r\n\t\t\tfieldClean($table);\r\n\r\n\t\t\t$schema = schema();\r\n\t\t\r\n\t\t\t<span style=\"color:Green\">// Build clause</span>\r\n\t\t\t<span style=\"color:Blue\">if</span> (sizeof($vars) &gt; 0) {\r\n\t\t\t\t$fields = <span style=\"color:#A31515\">''</span>;\r\n\t\t\t\t$values = <span style=\"color:#A31515\">''</span>;\r\n\t\t\t\t<span style=\"color:Blue\">foreach</span>($vars <span style=\"color:Blue\">as</span> $key =&gt; $value) {\r\n\t\t\t\t\tfieldClean($key);\r\n\r\n\t\t\t\t\t<span style=\"color:Green\">// Handle NULL values</span>\r\n\t\t\t\t\t<span style=\"color:Blue\">if</span> (<span style=\"color:Blue\">isset</span>($nulls[$key])) $tmp = <span style=\"color:#A31515\">'NULL'</span>;\r\n\t\t\t\t\t<span style=\"color:Blue\">else</span> $tmp = formatValue($types[$key], $format[$key], $value);\r\n\r\n\t\t\t\t\t<span style=\"color:Blue\">if</span> ($fields) $fields .= <span style=\"color:#A31515\">&quot;, \\&quot;{$key}\\&quot;&quot;</span>;\r\n\t\t\t\t\t<span style=\"color:Blue\">else</span> $fields = <span style=\"color:#A31515\">&quot;INSERT INTO {$schema}\\&quot;{$table}\\&quot; (\\&quot;{$key}\\&quot;&quot;</span>;\r\n\r\n\t\t\t\t\t<span style=\"color:Blue\">if</span> ($values) $values .= <span style=\"color:#A31515\">&quot;, {$tmp}&quot;</span>;\r\n\t\t\t\t\t<span style=\"color:Blue\">else</span> $values = <span style=\"color:#A31515\">&quot;) VALUES ({$tmp}&quot;</span>;\r\n\t\t\t\t}\r\n\t\t\t\t$sql = $fields . $values . <span style=\"color:#A31515\">')'</span>;\r\n\t\t\t}\r\n\t\t\t<span style=\"color:Blue\">return</span> $sql;\r\n\t\t}\r\n\t}\r\n\t<span style=\"color:Green\">//End phppgfunctions</span>\r\n\r\n<span style=\"color:Green\">//Get column names from file and place them in an array</span>\r\n$fields = <span style=\"color:Blue\">array</span>();\r\n<span style=\"color:Blue\">for</span> ($row = 1; $row &lt; 2; ++$row) {\r\n\t<span style=\"color:Blue\">for</span> ($col = 0; $col &lt; $highestColumnIndex; ++$col) {\r\n\t\t   $fields[$col]=  strtolower($tmpfields[$col] = $values[$row][$col] = $objWorksheet-&gt;getCellByColumnAndRow($col, $row)-&gt;getValue());\r\n\t\t\t\r\n\t}\r\n}\r\n\r\n$line = <span style=\"color:Blue\">array</span>();\r\n<span style=\"color:Green\">//We start on the line AFTER the field names</span>\r\n\t\t\t\t\t<span style=\"color:Green\">//grab a line from the file into array $line</span>\r\n\t\t\t\t\t<span style=\"color:Blue\">for</span> ($row = 2; $row &lt;= $highestRow; ++$row) {\r\n\t<span style=\"color:Blue\">for</span> ($col = 0; $col &lt; $highestColumnIndex; ++$col) {\r\n\t\t   $line[$col]=  $tmpfields[$col] = $values[$row][$col] = $objWorksheet-&gt;getCellByColumnAndRow($col, $row)-&gt;getValue();\r\n\t\t     \r\n\t\t\t <span style=\"color:Green\">//This part needs some work-- handling null cells works in conjunction with allowed_nulls above</span>\r\n\t\t\t  <span style=\"color:Blue\">if</span> (!<span style=\"color:Blue\">isset</span>($line[$col])) {\r\n\t\t\t\t\t\t\t$line[$col] =<span style=\"color:#A31515\">''</span>;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t<span style=\"color:Green\">// Build value map</span>\r\n\t\t\t\t\t\t$vars = <span style=\"color:Blue\">array</span>();\r\n\t\t\t\t\t\t$nulls = <span style=\"color:Blue\">array</span>();\r\n\t\t\t\t\t\t$format = <span style=\"color:Blue\">array</span>();\r\n\t\t\t\t\t\t$types = <span style=\"color:Blue\">array</span>();\r\n\t\t\t\t\t\t$i = 0;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t<span style=\"color:Blue\">foreach</span> ($fields <span style=\"color:Blue\">as</span> $f) {\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t<span style=\"color:Green\">// Check that there is a column</span>\r\n\t\t\t\t\t\t\t<span style=\"color:Blue\">if</span> (!<span style=\"color:Blue\">isset</span>($line[$i])) {\r\n\t\t\t\t\t\t\t\t<span style=\"color:Blue\">echo</span> <span style=\"color:#A31515\">'bad column'</span>;\r\n\t\t\t\t\t\t\t\t<span style=\"color:Blue\">exit</span>;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t<span style=\"color:Green\">// Check for nulls</span>\r\n\t\t\t\t\t\t\t<span style=\"color:Blue\">if</span> (determineNull($line[$i], $null_array)) {\r\n\t\t\t\t\t\t\t\t$nulls[$f] = <span style=\"color:#A31515\">'on'</span>;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t<span style=\"color:Green\">// Add to value array</span>\r\n\t\t\t\t\t\t\t$vars[$f] = $line[$i];\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t\t\t<span style=\"color:Green\">// Format is always VALUE</span>\r\n\t\t\t\t\t\t\t$format[$f] = <span style=\"color:#A31515\">'VALUE'</span>;\r\n\t\t\t\t\t\t\t<span style=\"color:Green\">// Type is always text</span>\r\n\t\t\t\t\t\t\t$types[$f] = <span style=\"color:#A31515\">'text'</span>;\r\n\t\t\t\t\t\t\t$i++;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t$status = insertRow($table, $vars, $nulls, $format, $types);\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t$result = pg_query($conn, $status);\r\n\t\t\t\t\t\t\t\t}\r\n?&gt;\r\n</pre>\r\n</div>\r\n<p>&nbsp;</p>",
    "PostedDate": "2009-08-10T21:11:56.92-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  }
]