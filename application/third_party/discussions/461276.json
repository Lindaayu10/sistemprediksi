[
  {
    "Id": "1104024",
    "ThreadId": "461276",
    "Html": "So, I have a small script, which takes xls/xlsx file, scans it for keywords, highlights them and then dumps content into xlsx file.\r<br />\n<br />\nThe problem is when I open resulting file, I have duplicated values in cells so if cell has content &quot;Test&quot; it would be &quot;TestTest&quot;.\r<br />\n<br />\nI tried switching from Excel2007 to Excel5 export and that partially fixed the problem: duplication of content had gone, but after a some point data is becoming an unreadable mix of unicode characters like that: 㼀䀄㠄䀄㸄㐄㴄㸄㌄㸄 䈀㸄㼄㬄㠄㈄〄 㸀㄄㔄䤄〄丄䈄 ㌀〄㜄㠄䐄㠄䘄㠄䀄㸄㈄〄䈄䰄⸄ ᨀ㸄㰄㰄㔄㴄䈄〄䀄㠄㤄 ㌀㔄㴄㔄䀄〄㬄䰄㴄㸄㌄㸄 㐀㠄䀄㔄㨄䈄㸄䀄〄 ḀḄḄ ∀ጀ〄㜄㼄䀄㸄㰄 㰀㔄㘄䀄㔄㌄㠄㸄㴄\r<br />\n<br />\n<br />\nThe way I manage files:<br />\n<pre><code>$reader   = PHPExcel_IOFactory::createReader($filetype);\n$phpexcel = $reader-&gt;load($this-&gt;inputFile);\n$sheet    = $phpexcel-&gt;getActiveSheet();\n$regex = '/\\b(' . implode('|', $this-&gt;keywords) . ')/ui';\n\nfor ($row = 1; $row &lt;= $maxRow; $row++) {\n    for ($col = 0; $col &lt;= $maxCol; $col++) {\n      $text     = $sheet-&gt;getCellByColumnAndRow($col, $row)-&gt;getFormattedValue();\n      $tokens   = preg_split($regex, $text, -1, PREG_SPLIT_DELIM_CAPTURE);\n      $richtext = $this-&gt;formatTokens($tokens);\n      $sheet    = $sheet-&gt;setCellValueByColumnAndRow($col, $row, $richtext);\n    }\n}\n\n$writer = PHPExcel_IOFactory::createWriter($phpexcel, 'Excel2007');\n$writer-&gt;save($this-&gt;outputFile);</code></pre>\n\nThe highlighting function:<br />\n<pre><code>function formatTokens($tokens) {\n      $richtext = new PHPExcel_RichText();\n      foreach($tokens as $token) {\n        $coloredText = $richtext-&gt;createTextRun($token);\n        if (in_array($token, $this-&gt;keywords)) {\n          $coloredText-&gt;getFont()-&gt;setColor(new PHPExcel_Style_Color(PHPExcel_Style_Color::COLOR_DARKRED));\n        }\n        else {\n          $coloredText-&gt;getFont()-&gt;setColor(new PHPExcel_Style_Color(PHPExcel_Style_Color::COLOR_BLACK));\n        }\n      }\n      return $richtext;\n}</code></pre>\n\nAny help would be highly appreciated.<br />\n",
    "PostedDate": "2013-10-05T11:11:32.21-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  }
]