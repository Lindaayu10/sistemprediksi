[
  {
    "Id": "903778",
    "ThreadId": "392999",
    "Html": "\r\n<p>I am having a problem creating an XLSX file that contains a very large dataset. The data consists of 24 columns and 23,422 rows.</p>\r\n<p>Originally I was writing data to each cell individually using a loop. After doing research, I found that fromArray() should be used as it's more efficient. I modified my code to use fromArray() and it's still failing. I then found some information about\r\n caching and implemented that. Same results. Based on different changes to the code, I'm getting either a maximum execution time exceeded error (script was initially set to 90 seconds) or (if I set max execution time to 0)&nbsp;an allowed memory exhausted error,\r\n and I've set allowed memory to 384MB.</p>\r\n<p>Here's a code snippet of what I'm doing. Note, when I run this code with a smaller dataset, it functions just fine. It seems to be dying with the larger dataset.</p>\r\n<p>&nbsp;</p>\r\n<div style=\"color:black; background-color:white\">\r\n<pre><span style=\"color:green\">// Initiate cache</span>\n$cacheMethod = PHPExcel_CachedObjectStorageFactory::cache_to_phpTemp;\n$cacheSettings = <span style=\"color:blue\">array</span>( <span style=\"color:#a31515\">'memoryCacheSize'</span> =&gt; <span style=\"color:#a31515\">'32MB'</span>);\nPHPExcel_Settings::setCacheStorageMethod($cacheMethod, $cacheSettings);\n\n<span style=\"color:green\">// set up excel workbook</span>\n$excel = <span style=\"color:blue\">new</span> PHPExcel();\n$excel-&gt;getProperties()\n\t\t-&gt;setCreator(<span style=\"color:#a31515\">'creator'</span>)\n\t\t-&gt;setLastModifiedBy(<span style=\"color:#a31515\">'username'</span>)\n\t\t-&gt;setTitle(<span style=\"color:#a31515\">'Title of Report'</span>)\n\t\t-&gt;setSubject(<span style=\"color:#a31515\">'Title of Report'</span>)\n\t\t-&gt;setDescription(<span style=\"color:#a31515\">'Title of Report, run on '</span> . date(<span style=\"color:#a31515\">'m/d/Y H:i:s'</span>));\n$excel-&gt;createSheet(0);\n$excel-&gt;setActiveSheetIndex(0);\n$excel-&gt;getActiveSheet()-&gt;fromArray($source);\n\n<span style=\"color:green\">// save file</span>\n$writer = <span style=\"color:blue\">new</span> PHPExcel_Writer_Excel2007($excel);\n$filename = <span style=\"color:#a31515\">'report-'</span>.time().<span style=\"color:#a31515\">'.xlsx'</span>;\n$writer-&gt;save(<span style=\"color:#a31515\">'/path/to/'</span>.$filename);\n</pre>\r\n</div>\r\n<p>&nbsp;</p>\r\n<p>I've been researching the web and this forum for an hour or two trying to find related information but I'm now stuck. Any ideas?</p>\r\n",
    "PostedDate": "2012-08-24T14:20:39.45-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "903779",
    "ThreadId": "392999",
    "Html": "<p>Hello CreedFeed,</p>\r\n<p>the below code could help you.</p>\r\n<p>\r\n<div style=\"color: black; background-color: white;\">\r\n<pre><span style=\"color: green;\">/** Set Memory Limit */</span>\r\n    ini_set(<span style=\"color: #a31515;\">\"memory_limit\"</span>,<span style=\"color: #a31515;\">\"500M\"</span>); <span style=\"color: green;\">// set your memory limit in the case of memory problem</span><br /><br />if necessary you can try go up to 1000M <br /><br />BR<br />Frank<br /></pre>\r\n</div>\r\n</p>",
    "PostedDate": "2012-08-24T14:25:20.67-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "903780",
    "ThreadId": "392999",
    "Html": "<p>Unfortunately the server is configured to override ini_set with the value in php.ini and I am unable to change that.</p>\r\n<p>Besides the memory limit, it is taking forever to run. In my code snippet above, I removed the $excel-&gt;getProperties section of code and am rerunning it now. It's been running for about 5 minutes now and just finally died.</p>\r\n<p>I should add, the error I'm getting is:</p>\r\n<p>PHP Fatal error: &nbsp;Allowed memory size of 402653184 bytes exhausted (tried to allocate 48 bytes) in /path/to/PHPExcel/CachedObjectStorage/CacheBase.php on line 155</p>\r\n<p>It seems weird the cache code is the one eating up the memory, shouldn't it be using phpTemp to store the data? (I have no idea how the cache code works lol)</p>",
    "PostedDate": "2012-08-24T14:31:51.387-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "903786",
    "ThreadId": "392999",
    "Html": "\r\n<p>Try this one to use discISAM see manual this had help me some time but now I've so large files so I need myself help from the team see my Discussion point\r\n<a title=\"Link\" href=\"http://phpexcel.codeplex.com/discussions/392997\" target=\"_blank\">\r\nhttp://phpexcel.codeplex.com/discussions/392997</a></p>\r\n<pre><span style=\"color:green\">/** Caching to discISAM 1.0*/</span>\n$cacheMethod = PHPExcel_CachedObjectStorageFactory:: cache_to_discISAM;\n$cacheSettings = <span style=\"color:blue\">array</span>( <span style=\"color:#a31515\">'dir'</span>  =&gt; <span style=\"color:#a31515\">'/usr/local/tmp'</span> <span style=\"color:green\">// If you have a large file you can cache it optional</span>\n                      );\nPHPExcel_Settings::setCacheStorageMethod($cacheMethod, $cacheSettings);\n<br></pre>\r\n",
    "PostedDate": "2012-08-24T14:44:20.097-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "903831",
    "ThreadId": "392999",
    "Html": "<blockquote style=\"padding-bottom: 0px; font-style: italic; margin: 0.25em 1em 0px; padding-left: 0.25em; padding-right: 0.25em; padding-top: 0px; border: #ccc 0.1em solid;\"><strong>CreedFeed wrote:</strong><br />\r\n<p>Besides the memory limit, it is taking forever to run. In my code snippet above, I removed the $excel-&gt;getProperties section of code and am rerunning it now. It's been running for about 5 minutes now and just finally died.</p>\r\n</blockquote>\r\n<p>Removing the getProperties() section of the code is a minimal saving, it will make no perceptible difference in time or memory usage.</p>\r\n<p>Using fromArray() is more efficient than writing to each cell individually, but if you have 24 columns and 23,422 rows in your $source array, then $source is taking a lot of memory. An easier compromise (especially if you're building your $source&nbsp;one row at a time, perhaps from a database query) is to populate each row in turn in $source, then use fromArray()&nbsp;for that&nbsp;row, then repopulate $source with the next row, and so on.</p>\r\n<p>&nbsp;</p>\r\n<blockquote style=\"padding-bottom: 0px; font-style: italic; margin: 0.25em 1em 0px; padding-left: 0.25em; padding-right: 0.25em; padding-top: 0px; border: #ccc 0.1em solid;\"><strong>CreedFeed wrote:</strong><br />\r\n<p>It seems weird the cache code is the one eating up the memory, shouldn't it be using phpTemp to store the data? (I have no idea how the cache code works lol)</p>\r\n</blockquote>\r\n<p>&nbsp;The cache code isn't eating the memory... the cell data is. All cells are stored in a \"cache\", but the default cache is fully in memory. The cache handler logic serves as a wrapper for different storage media such as memory, php://temp, sqlite, disk, APC, etc as described in the manual, each of which then has its own individual code. It will only use php://temp if you've told it to use php://temp. Even then, it maintains an in-memory index, allowing it to access the cell more quickly in the cache.</p>\r\n<p>All caching is a trade-off between speed and memory. The lower the memory usage, the more execution time overhead in its use. \"Memory\" is the fastest, but uses the largest amount of memory, SQLite is the most efficient use of memory, but among the slowest methods. The caching wrapper</p>",
    "PostedDate": "2012-08-24T17:00:46.927-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "904619",
    "ThreadId": "392999",
    "Html": "<p>Mark &gt; I took your suggestion and rewrote my script to use fromArray() once for each row, because as you assumed, I was pulling data from a single query. I have good news and bad news. Good news is, it worked!&nbsp;<span>24 columns and 23,422 rows of data was written. The bad news: it took about 15 minutes to finish. I used the following code:</span></p>\r\n<p><span>\r\n<div style=\"color: black; background-color: white;\">\r\n<pre>ini_set(<span style=\"color: #a31515;\">\"memory_limit\"</span>, <span style=\"color: #a31515;\">\"384M\"</span>); <span style=\"color: green;\">// set in php.ini, I cannot change this</span>\r\nset_time_limit(0);\r\n\r\n<span style=\"color: green;\">// Initiate cache</span>\r\n$cacheMethod = PHPExcel_CachedObjectStorageFactory::cache_to_phpTemp;\r\n$cacheSettings = <span style=\"color: blue;\">array</span>( <span style=\"color: #a31515;\">'memoryCacheSize'</span> =&gt; <span style=\"color: #a31515;\">'32MB'</span>);\r\nPHPExcel_Settings::setCacheStorageMethod($cacheMethod, $cacheSettings);\r\n\r\n<span style=\"color: green;\">// set up excel workbook</span>\r\n$excel = <span style=\"color: blue;\">new</span> PHPExcel();\r\n$excel-&gt;getProperties()\r\n\t\t-&gt;setCreator(<span style=\"color: #a31515;\">'creator'</span>)\r\n\t\t-&gt;setLastModifiedBy(<span style=\"color: #a31515;\">'username'</span>)\r\n\t\t-&gt;setTitle(<span style=\"color: #a31515;\">'Title of Report'</span>)\r\n\t\t-&gt;setSubject(<span style=\"color: #a31515;\">'Title of Report'</span>)\r\n\t\t-&gt;setDescription(<span style=\"color: #a31515;\">'Title of Report, run on '</span> . date(<span style=\"color: #a31515;\">'m/d/Y H:i:s'</span>));\r\n$excel-&gt;createSheet(0);\r\n$excel-&gt;setActiveSheetIndex(0);\r\n\r\n<span style=\"color: green;\">// set up query here</span>\r\n$query = <span style=\"color: #a31515;\">\"MY QUERY\"</span>;\r\n$obj = <span style=\"color: blue;\">new</span> Object();\r\n$obj-&gt;query($query);\r\n<span style=\"color: blue;\">while</span> ($obj-&gt;fetch()) {\r\n\r\n\t$source = <span style=\"color: blue;\">array</span>();\r\n\t$source[0] = <span style=\"color: blue;\">array</span>( my data here );\r\n\r\n\t$excel-&gt;getActiveSheet()-&gt;fromArray($source);\r\n\r\n\t<span style=\"color: blue;\">unset</span>($source);\r\n}\r\n\t\r\n<span style=\"color: green;\">// save file</span>\r\n$writer = <span style=\"color: blue;\">new</span> PHPExcel_Writer_Excel2007($excel);\r\n$filename = <span style=\"color: #a31515;\">'report-'</span>.time().<span style=\"color: #a31515;\">'.xlsx'</span>;\r\n$writer-&gt;save(<span style=\"color: #a31515;\">'/path/to/'</span>.$filename);\r\n</pre>\r\n</div>\r\n</span></p>\r\n<p>Anything else you can recommend to speed this up some? Is there a different cache method that would increase time? Anything?</p>\r\n<p>Thanks for your feedback up to this point! I really appreciate it, and appreciate your work on this project! It's a great library!</p>",
    "PostedDate": "2012-08-27T07:37:26.783-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  }
]