[
  {
    "Id": "958681",
    "ThreadId": "407390",
    "Html": "\r\n<p>Good afternoon for all, I'm generating an XLS and a PDF with PHPExcel in my development environment works perfect,&nbsp;but when publish the application in the server, the system generates the file but when&nbsp;I open file generated with 1K in size I get\r\n an error saying the file does not match the format or is damaged,&nbsp;what can ido? the code that generates the PDF is:</p>\r\n<p><span>&lt;?php</span><br>\r\n<br>\r\n<span>//Traemos las librerias necesarias</span><br>\r\n<span>require_once(&quot;Classes/PHPExcel.php&quot;);</span><br>\r\n<span>require_once(&quot;Classes/PHPExcel/Writer/Excel2007.php&quot;);</span><br>\r\n<span>require_once('Classes/PHPExcel/IOFactory.php');</span><br>\r\n<span>require_once('../../../raxan/pdi/autostart.php');</span><br>\r\n<br>\r\n<span>Raxan::loadConfig('../config.php'); // load external config file</span><br>\r\n<span>Raxan::config('site.timezone','America/Toronto'); // set timezone</span><br>\r\n<br>\r\n<span>class NewPage extends RaxanWebPage {</span><br>\r\n<br>\r\n<span>protected $db;</span><br>\r\n<br>\r\n<span>protected function _config() {</span><br>\r\n<span>$this-&gt;degradable = true;</span><br>\r\n<span>// enable or disable debugging</span><br>\r\n<span>$this-&gt;Raxan-&gt;config('debug', false);</span><br>\r\n<span>try {</span><br>\r\n<span>$this-&gt;db = $this-&gt;Raxan-&gt;connect('booking'); // connect to db</span><br>\r\n<span>}</span><br>\r\n<span>catch (Exception $e) {</span><br>\r\n<span>$this-&gt;db = null;</span><br>\r\n<span>$msg = $this-&gt;getView('connection-failed.html');</span><br>\r\n<span>$this-&gt;flashmsg($msg,'bounce','rax-box error');</span><br>\r\n<span>}&nbsp;</span><br>\r\n<span>}</span><br>\r\n<br>\r\n<span>protected function _init() {</span><br>\r\n<span>$idR = $this-&gt;get-&gt;intVal('idReserva');&nbsp;</span><br>\r\n<span>$sql ='SELECT sum(totFulles) as tf, sum(totPiezas) as tp, sum(peso) as tps&nbsp;</span><br>\r\n<span>FROM clientes1 where idReserva=? group by idReserva';</span><br>\r\n<span>$rows = $this-&gt;db-&gt;execQuery($sql,$idR);</span><br>\r\n<span>$tps=0;</span><br>\r\n<span>$tp=0;</span><br>\r\n<span>$tf=0;</span><br>\r\n<span>$awb = '';&nbsp;</span><br>\r\n<span>$fvuelo = '';</span><br>\r\n<span>$etd = '';</span><br>\r\n<span>$eta = '';</span><br>\r\n<span>$ctd = '';</span><br>\r\n<span>$cta = '';</span><br>\r\n<span>$vuelo = '';</span><br>\r\n<span>$tps = 0;&nbsp;</span><br>\r\n<span>$tp = 0;</span><br>\r\n<span>$tf = 0;</span><br>\r\n<span>$shiper='';</span><br>\r\n<span>if ($rows){</span><br>\r\n<span>$tps = (double)$rows[0]['tps'];&nbsp;</span><br>\r\n<span>$tp = (int)$rows[0]['tp'];</span><br>\r\n<span>$tf = (double)$rows[0]['tf'];</span><br>\r\n<span>}</span><br>\r\n<span>$sql='SELECT * FROM reservageneral where idReserva=?';</span><br>\r\n<span>$rows = $this-&gt;db-&gt;execQuery($sql,$idR);</span><br>\r\n<span>if ($rows){</span><br>\r\n<span>$awb = $rows[0]['awb'];&nbsp;</span><br>\r\n<span>$fvuelo = $rows[0]['fvuelo'];</span><br>\r\n<span>$etd = $rows[0]['ETD'];</span><br>\r\n<span>$eta = $rows[0]['ETA'];</span><br>\r\n<span>$ctd = $rows[0]['CTD'];</span><br>\r\n<span>$cta = $rows[0]['CTA'];</span><br>\r\n<span>$vuelo = $rows[0]['codigoVuelo'];&nbsp;</span><br>\r\n<span>$shiper = $rows[0]['shipper'];&nbsp;</span><br>\r\n<span>}</span><br>\r\n<br>\r\n<span>$fileType = 'Excel5';</span><br>\r\n<span>$fileName = 'prealerta.xls';</span><br>\r\n<br>\r\n<span>//objeto de PHP Excel</span><br>\r\n<span>//$objPHPExcel = new PHPExcel();</span><br>\r\n<br>\r\n<span>// Read the file</span><br>\r\n<span>//$objReader = PHPExcel_IOFactory::createReader($fileType);</span><br>\r\n<span>//$objPHPExcel = $objReader-&gt;load($fileName);</span><br>\r\n<span>$objPHPExcel = PHPExcel_IOFactory::load($fileName);</span><br>\r\n<br>\r\n<span>// Change the file</span><br>\r\n<span>$objPHPExcel-&gt;setActiveSheetIndex(0)</span><br>\r\n<span>-&gt;setCellValue('B5', $awb)//Master</span><br>\r\n<span>-&gt;setCellValue('B6', $fvuelo)//Fecha</span><br>\r\n<span>-&gt;setCellValue('B7', $vuelo)//Vuelo</span><br>\r\n<span>-&gt;setCellValue('B8', $tf)//Tot Fulles</span><br>\r\n<span>-&gt;setCellValue('B9', $tp)//Tot Piezas</span><br>\r\n<span>-&gt;setCellValue('B10', $tps)//Tot peso</span><br>\r\n<span>-&gt;setCellValue('D4', $shiper)//Shipper</span><br>\r\n<span>-&gt;setCellValue('D5', $etd)//ETD</span><br>\r\n<span>-&gt;setCellValue('D6', $eta)//ETA</span><br>\r\n<span>-&gt;setCellValue('F5', $ctd)//CTD</span><br>\r\n<span>-&gt;setCellValue('F6', $cta);//CTA</span><br>\r\n<br>\r\n<span>//Detalle</span><br>\r\n<span>$sql = 'SELECT idReserva,totFulles,totPiezas,octavos,cuartos,taba co,fulles,peso,hawb,tipo,consignee&nbsp;</span><br>\r\n<span>FROM clientes1 where idReserva=? order by hawb';</span><br>\r\n<span>$filas = $this-&gt;db-&gt;execQuery($sql,$idR);</span><br>\r\n<span>$row = 14;</span><br>\r\n<span>foreach($filas as $rows){</span><br>\r\n<span>$objPHPExcel-&gt;getActiveSheet()-&gt;SetCellValue(&quot;A&quot;.$row, $rows['hawb']);//hawb</span><br>\r\n<span>$objPHPExcel-&gt;getActiveSheet()-&gt;SetCellValue(&quot;B&quot;.$row, $rows['consignee']);//Consignee</span><br>\r\n<span>$objPHPExcel-&gt;getActiveSheet()-&gt;setCellValue(&quot;C&quot;.$row, $rows['octavos']);//1/8</span><br>\r\n<span>$objPHPExcel-&gt;getActiveSheet()-&gt;setCellValue(&quot;D&quot;.$row, $rows['cuartos']);//1/4</span><br>\r\n<span>$objPHPExcel-&gt;getActiveSheet()-&gt;setCellValue(&quot;E&quot;.$row, $rows['tabaco']);//tabacos</span><br>\r\n<span>$objPHPExcel-&gt;getActiveSheet()-&gt;setCellValue(&quot;F&quot;.$row, $rows['fulles']);//fulles</span><br>\r\n<span>$objPHPExcel-&gt;getActiveSheet()-&gt;setCellValue(&quot;G&quot;.$row, $rows['totFulles']);//tot fules</span><br>\r\n<span>$objPHPExcel-&gt;getActiveSheet()-&gt;setCellValue(&quot;H&quot;.$row, $rows['totPiezas']);//tot piezas</span><br>\r\n<span>$objPHPExcel-&gt;getActiveSheet()-&gt;setCellValue(&quot;I&quot;.$row, $rows['peso']);//peso&nbsp;</span><br>\r\n<span>$row&#43;&#43;;&nbsp;</span><br>\r\n<span>}</span><br>\r\n<br>\r\n<span>//Titulo del libro y seguridad&nbsp;</span><br>\r\n<span>$objPHPExcel-&gt;getActiveSheet()-&gt;setTitle('Reporte');</span><br>\r\n<span>$objPHPExcel-&gt;getSecurity()-&gt;setLockWindows(true);</span><br>\r\n<span>$objPHPExcel-&gt;getSecurity()-&gt;setLockStructure(true);</span><br>\r\n<span>$objPHPExcel-&gt;getActiveSheet()-&gt;setShowGridLines(false);&nbsp;</span><br>\r\n<br>\r\n<span>// Se modifican los encabezados del HTTP para indicar que se envia un archivo de PDF.</span><br>\r\n<span>header('Content-Type: application/pdf');</span><br>\r\n<span>header('Content-Disposition: attachment;filename=&quot;Reporte.pdf&quot;');</span><br>\r\n<span>header('Cache-Control: max-age=0');</span><br>\r\n<span>$rendererName = PHPExcel_Settings::PDF_RENDERER_MPDF;</span><br>\r\n<span>$rendererLibrary = 'mPDF5.4';</span><br>\r\n<span>$rendererLibraryPath = dirname(__FILE__).'\\Classes\\PDF\\\\'. $rendererLibrary;//&nbsp;</span><br>\r\n<span>if (!PHPExcel_Settings::setPdfRenderer(</span><br>\r\n<span>$rendererName,</span><br>\r\n<span>$rendererLibraryPath</span><br>\r\n<span>)) {</span><br>\r\n<span>die(</span><br>\r\n<span>'Please set the $rendererName and $rendererLibraryPath values' .</span><br>\r\n<span>PHP_EOL .</span><br>\r\n<span>' as appropriate for your directory structure'</span><br>\r\n<span>);</span><br>\r\n<span>}&nbsp;</span><br>\r\n<span>$objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'PDF');</span><br>\r\n<span>$objWriter-&gt;save('php://output');</span><br>\r\n<br>\r\n<span>// Echo memory peak usage</span><br>\r\n<span>echo date('H:i:s') . &quot; Peak memory usage: &quot; . (memory_get_peak_usage(true) / 1024 / 1024) . &quot; MBrn&quot;;</span><br>\r\n<span>// Echo done</span><br>\r\n<span>echo date('H:i:s') . &quot; Done writing files.rn&quot;;&nbsp;</span><br>\r\n<span>//$objWriter-&gt;save('php://output');</span><br>\r\n<span>exit;</span><br>\r\n<span>}</span><br>\r\n<span>}</span><br>\r\n<span>?&gt;</span></p>\r\n",
    "PostedDate": "2012-12-19T12:39:35.977-08:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "961140",
    "ThreadId": "407390",
    "Html": "\r\n<p><span id=\"AjaxWaitImage\" style=\"visibility:hidden\"></span></p>\r\n<div id=\"TranslationOutput\" dir=\"ltr\">\r\n<div><span><span>Open the bad file with a text editor, examine the file of php errors that should store your server.\r\n</span><span>You should find clues for the problem</span></span></div>\r\n<div><span><span>Recent PHPExcel versions don't include the pdf library (in return, you have the choice).\r\n</span><span>Do you have the same version in dev' and prod'? </span><span>The pdf library is present on production server?\r\n</span><span>Problem of write (temporary file) on a machine with a more strict configuration ? Etc.<br>\r\n</span></span></div>\r\n</div>\r\n",
    "PostedDate": "2012-12-20T04:11:54.46-08:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  }
]