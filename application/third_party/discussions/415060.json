[
  {
    "Id": "966969",
    "ThreadId": "415060",
    "Html": "\r\n<p>Greetings to All!</p>\r\n<p>I am running a school management system. &nbsp;The following code creates a simple array to hold a report structure which is then dumped to an Excel file. It works flawlessly with small arrays (small&nbsp;data-sets) but when the array gets larger, the numbers\r\n in the first row are repeated in all subsequent cells below it...somewhat annoying... It could be an issue of output buffering but no improvement has been noted on 'tweaking' the buffer size. &nbsp;On the other hand I do not think that 50 columns of about\r\n 100 rows each is excessively large...</p>\r\n<p>[php version: 5.3.0; PHPExcel version: 1.7.6]</p>\r\n<p>Here's the offending code snippet (sorry for the size):</p>\r\n<p>&nbsp;</p>\r\n<p></p>\r\n<pre>&lt;!--?php session_start();\r\nif (@$HTTP_SESSION_VARS[&quot;login_status&quot;] &lt;--&gt; &quot;login&quot;){\r\n\theader(&quot;Location: flogin.php&quot;);\r\n\tdie();\r\n}\r\n\r\n/** Error reporting */\r\nerror_reporting(E_ALL);\r\n\r\nrequire_once 'config.php';\r\nrequire_once 'functions.php';\r\nrequire_once 'GradeBook/gradefunctions.php';\r\n\r\n\r\n/** PHPExcel */\r\nrequire_once dirname(__FILE__) . '/Classes/PHPExcel.php';\r\n/** PHPExcel_IOFactory */\r\nrequire_once '/Classes/PHPExcel/IOFactory.php';\r\n// This is to pre-empt the maximum execution time problem\r\n//set_time_limit(0);\r\n\r\nini_set('memory_limit','1024M');\r\nini_set('mysql.connect_timeout', 600);\r\nini_set('default_socket_timeout', 600);\r\n//ini_set('max_execution_time','600');\r\n\r\n//setting mem cache...\r\n//$cacheMethod = PHPExcel_CachedObjectStorageFactory::cache_in_memory_serialized;\r\n$cacheMethod = PHPExcel_CachedObjectStorageFactory::cache_in_memory;\r\n$cacheSettings = array( 'memcacheServer'  =&gt; 'localhost',\r\n                        'memcachePort'    =&gt; 11211,\r\n                        'cacheTime'       =&gt; 600\r\n                      );\r\nif (!PHPExcel_Settings::setCacheStorageMethod($cacheMethod,$cacheSettings))\r\n   die('CACHEING ERROR');\r\n\r\n// Create new PHPExcel object\r\n$objPHPExcel = new PHPExcel();\r\n\r\n// Set properties\r\n//echo date('H:i:s') . &quot; Set properties\\n&quot;;\r\n$objPHPExcel-&gt;getProperties()-&gt;setCreator(&quot;Paul Mimbi&quot;)\r\n\t\t\t\t\t\t\t -&gt;setLastModifiedBy(&quot;Paul Mimbi&quot;)\r\n\t\t\t\t\t\t\t -&gt;setTitle(&quot;stgr Academic Report&quot;)\r\n\t\t\t\t\t\t\t -&gt;setSubject(&quot;Studies Chart&quot;)\r\n\t\t\t\t\t\t\t -&gt;setDescription(&quot;Document generated using PHP classes.&quot;)\r\n\t\t\t\t\t\t\t -&gt;setKeywords(&quot;office 2007 openxml php&quot;)\r\n\t\t\t\t\t\t\t -&gt;setCategory(&quot;File for Decision Making Purposes&quot;);\r\n\r\n//colour schemes\r\n$light_green = 'ACE600';\r\n$deep_green = '004900';\r\n$amber = 'FF6600';\r\n$red = 'FF0000';\r\n$purple = 'D9007E';\r\n$purple_blue = '8800CC';\r\n$deep_blue = '2200CC';\r\n$sky_blue1 = '0099CC';\r\n$sky_blue2 = '33FFCC';\r\n$sky_blue3 = '33CCFF';\r\n$grey = 'C3C3C3';\r\n$white= 'FFFFFF';\r\n\r\n/* set hyperlink for retriving f10s, Actae, etc...\r\nby getting the absolute path of the page, independent from the site position (local machine or server)\r\nand from the server OS - works both on Unix systems and Windows systems.*/\r\n$conflen=strlen('istudium');\r\n$B=substr(__FILE__,0,strrpos(__FILE__,'/'));\r\n$A=substr($_SERVER['DOCUMENT_ROOT'], strrpos($_SERVER['DOCUMENT_ROOT'], $_SERVER['PHP_SELF']));\r\n$C=substr($B,strlen($A));\r\n$posconf=strlen($C)-$conflen-1;\r\n$D=substr($C,1,$posconf);\r\n$host='http://'.$_SERVER['SERVER_NAME'].'/'.$D;\r\n\r\n// read data from recordset...\r\n$qryf10 = &quot;SELECT DISTINCT st.StudentId AS sID, c.CourseId, c.CourseCode, c.Course, t.Score AS tScore, \r\n\t\t\tt.MaxScore AS tMax, e.MaxScore AS eMax, m.Marks AS mScore, m.ExamId AS ExamId, c.ProgramId, \r\n\t\t\tc.SemesterId, s.SemesterDescription, st.CivilStatusId AS cStatus\r\n\t\t\tFROM courses c \r\n\t\t\tLEFT JOIN exams e ON c.CourseId = e.CourseId\r\n\t\t\tLEFT JOIN marks m ON e.ExamId = m.ExamId\r\n            LEFT JOIN transcripts t ON c.CourseId = t.CourseId\r\n\t\t\tINNER JOIN students st ON t.StudentId = st.StudentId OR m.StudentId = st.StudentId\r\n\t\t\tLEFT JOIN semesters s ON c.SemesterId = s.SemesterId\r\n\t\t\tWHERE st.ProgramId IN (1, 3)\r\n\t\t\tAND c.ProgramId IN (1, 3) \r\n\t\t\tAND st.CivilStatusId IN (1, 2)\r\n\t\t\tORDER BY st.CivilStatusId, c.ProgramId, c.SemesterId, st.StudentId, c.CourseId  ASC&quot;;\r\n/* This one also works...\r\n$qryf10 = &quot;SELECT st.StudentId AS sID, c.CourseId, c.CourseCode, c.Course, t.Score AS tScore, t.MaxScore AS tMax, e.MaxScore AS eMax,\r\n\t\t   m.Marks AS mScore, m.ExamId AS ExamId, c.ProgramId, c.SemesterId, s.SemesterDescription, st.CivilStatusId AS cStatus\r\n\t\t\tFROM courses c\r\n            LEFT JOIN semesters s ON c.SemesterId = s.SemesterId\r\n\t\t\tLEFT JOIN exams e ON c.CourseId = e.CourseId\r\n\t\t\tLEFT JOIN marks m ON e.ExamId = m.ExamId\r\n\t\t\tLEFT JOIN transcripts t ON c.CourseId = t.CourseId\r\n\t\t\tLEFT JOIN students st ON t.StudentId = st.StudentId OR m.StudentId = st.StudentId\r\n\t\t\tWHERE c.ProgramId IN (1, 3) \r\n\t\t\tAND st.CivilStatusId IN (1, 2)\r\n\t\t\tORDER BY st.CivilStatusId, c.ProgramId, c.SemesterId, st.StudentId, c.CourseId  ASC&quot;;\r\n*/\t\t\t\r\n$rstf10 = mysql_query($qryf10, $ServerConnect) or die(mysql_error());\r\n$numf10 = mysql_num_rows($rstf10);\r\n//mysql_data_seek ($rstf10 , 0 );\r\n\r\n// Query to fetch the individual courses per civil status, per program per semester\r\n$query_subjects = 'SELECT DISTINCT c.CourseId, c.Course, c.CourseCode, c.ProgramId, c.SemesterId,\r\n\t\t\ts.SemesterDescription, st.CivilStatusId AS cStatus\r\n\t\t\tFROM courses c \r\n\t\t\tLEFT JOIN transcripts t ON c.CourseId = t.CourseId\r\n\t\t\tLEFT JOIN semesters s ON c.SemesterId = s.SemesterId\r\n\t\t\tLEFT JOIN exams e ON c.CourseId = e.CourseId\r\n\t\t\tLEFT JOIN marks m ON e.ExamId = m.ExamId\r\n\t\t\tINNER JOIN students st ON t.StudentId = st.StudentId OR m.StudentId = st.StudentId\r\n\t\t\tWHERE c.ProgramId = %d\r\n\t\t\tAND st.CivilStatusId= %d\r\n\t\t\tAND c.SemesterId = %d \r\n\t\t\tORDER BY st.CivilStatusId, c.ProgramId, c.SemesterId, c.CourseId  ASC';\r\n\r\n/*OLD QUERY...DOES NOT WORK WHEN MARKS TABLE IS EMPTY...\r\n\t$query_subjects = 'SELECT DISTINCT c.CourseId, c.Course, c.CourseCode, c.ProgramId, c.SemesterId,\r\n\t\t\ts.SemesterDescription, st.CivilStatusId AS cStatus\r\n\t\t\tFROM courses c \r\n\t\t\tLEFT JOIN transcripts t ON c.CourseId = t.CourseId\r\n\t\t\tLEFT JOIN exams e ON c.CourseId = e.CourseId\r\n\t\t\tLEFT JOIN marks m ON e.ExamId = m.ExamId\r\n\t\t\tLEFT JOIN students st ON m.StudentId = st.StudentId\r\n\t\t\tLEFT JOIN semesters s ON c.SemesterId = s.SemesterId\r\n\t\t\tWHERE c.ProgramId = %d\r\n\t\t\tAND st.CivilStatusId= %d\r\n\t\t\tAND c.SemesterId = %d \r\n\t\t\tORDER BY st.CivilStatusId, c.ProgramId, c.SemesterId, c.CourseId  ASC';\r\n*/\t\t\t/*\r\n\t\t\t*NB: I have removed AND st.StudentId IS NOT NULL from both\r\n\t\t\t*the queries; checked that it was not really necessary...\r\n\t\t\t*/\r\n\r\n// function for setting title colors...\r\nfunction getTitleColorArray($semester_id){\r\n\t$color = '';\r\n\tswitch($semester_id) {\r\n\t\tcase 1:\r\n\t\t\t$color = '99FF33';\r\n\t\t\tbreak;\r\n\t\tcase 2:\r\n\t\t\t$color = 'FFFF33';\r\n\t\t\tbreak;\r\n\t\tcase 3:\r\n\t\t\t$color = 'FF9933';\r\n\t\t\tbreak;\r\n\t\tcase 4:\r\n\t\t\t$color = 'FF3333';\r\n\t\t\tbreak;\r\n\t\tdefault:\r\n\t\t   $color = 'FFFFFF';\r\n\t}\r\n\t\r\n\treturn array(\r\n\t\t'font'    =&gt; array(\r\n\t\t\t'bold'      =&gt; true\r\n\t\t),\r\n\t\t'alignment' =&gt; array(\r\n\t\t\t'horizontal' =&gt; PHPExcel_Style_Alignment::HORIZONTAL_RIGHT,\r\n\t\t),\r\n\t\t'borders' =&gt; array(\r\n\t\t\t'top'     =&gt; array(\r\n\t\t\t\t'style' =&gt; PHPExcel_Style_Border::BORDER_THIN\r\n\t\t\t)\r\n\t\t),\r\n\t\t'fill' =&gt; array(\r\n\t\t\t'type'       =&gt; PHPExcel_Style_Fill::FILL_GRADIENT_LINEAR,\r\n\t\t\t'rotation'   =&gt; 90,\r\n\t\t\t'startcolor' =&gt; array(\r\n\t\t\t\t'rgb' =&gt; $color\r\n\t\t\t),\r\n\t\t\t'endcolor'   =&gt; array(\r\n\t\t\t\t'rgb' =&gt; 'FFFFFF'\r\n\t\t\t)\r\n\t\t)\r\n\t);\r\n}\r\n\t\r\n// Array to hold the report structure to be dumped to Excel\r\n$report  = array();\r\n\r\n// Initialize local temporary variable\r\n$civil_status = -1; \t// Keeps track of the current civil status\r\n$status_count = -1; \t//Counter for the civil status\r\n$program_count = -1; \t// Counter for the program\r\n$prog = -1;             // Keeps track of program id\r\n$semester_count = -1; \t// Counter for the semesters\r\n$student_count = -1;\t// Counter to keep track of the number of students per status,program and semester\r\n$student_id= -1; \t\t// Keeps track of the current student during the fetch\r\n$course_id = -1; \t\t//Keeps track of the current course/subject during the fetch\r\n$semester = -1; \t\t// Keeps track of the current semester during the fetch\r\n\r\nwhile ($rowf10 = mysql_fetch_assoc($rstf10)) {\t\t\t\t\r\n\t// Get the civil status\r\n\tif ($civil_status != $rowf10['cStatus']) {\r\n\t\t$status_count&#43;&#43;;\r\n\t\t$civil_status = $rowf10['cStatus'];\r\n\t\t\r\n\t\t$status_name = &quot;&quot;;\r\n\t\tswitch ($civil_status) {\r\n\t\t\tcase 1:\r\n\t\t\t\t$status_name = &quot;n&quot;;\r\n\t\t\t\tbreak;\r\n\t\t\tcase 2:\r\n\t\t\t\t$status_name = &quot;agd&quot;;\r\n\t\t\t\tbreak;\r\n\t\t\tcase 3:\r\n\t\t\t\t$status_name = &quot;s&quot;;\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\t$status_name = &quot;DiP&quot;;\r\n\t\t}\r\n\t\t$report[$status_count]['status_id'] = $civil_status;\r\n\t\t$report[$status_count]['civil_status'] = $status_name;\r\n\t}\r\n\t// Get the program\t\r\n\tif ($prog != $rowf10['ProgramId']) {\r\n\t\t$program_count&#43;&#43;;\r\n\t\t\r\n\t\t$prog = $rowf10['ProgramId'];\t\t\t\t\t\t\r\n\t\t$program   = getProgramName($prog, 1);\r\n\t\t\r\n\t\t$report[$status_count]['program'][$program_count]['id'] = $prog;\r\n\t\t$report[$status_count]['program'][$program_count]['name'] = $program;\r\n\t}\r\n\t\r\n\t// Get the semester\r\n\tif ($semester != $rowf10['SemesterId']) {\r\n\t\t$semester_count&#43;&#43;;\r\n\t\t$semester= $rowf10['SemesterId'];\r\n\t\t\r\n\t\t$report[$status_count]['program'][$program_count]['semester'][$semester_count]['semester_id'] = $semester;\r\n\t}\r\n\t\r\n\t// Get the student(s)\r\n\tif ($student_id != $rowf10['sID']) {\r\n\t\t$student_count&#43;&#43;;\r\n\t\t$student_id = $rowf10['sID'];\r\n\t\t\r\n\t\t$report[$status_count]['program'][$program_count]['semester'][$semester_count]['student'][$student_count]['student_id'] = $student_id;\r\n\t\t$report[$status_count]['program'][$program_count]['semester'][$semester_count]['student'][$student_count]['codes'] = array();\r\n\t\t$report[$status_count]['program'][$program_count]['semester'][$semester_count]['student'][$student_count]['examid'] = array();\r\n\t\t\r\n\t\t//if ($student_id == 26) echo $program.&quot;-&quot;.$semester.&quot;<br>&quot;;\r\n\t}\r\n\t\r\n\t//Get the subject/course and mark\r\n\tif ($course_id != $rowf10['CourseId']) {\r\n\t\t$course_id = $rowf10['CourseId'];\r\n\t}\r\n\t\t\r\n\tif($rowf10['mScore'] != NULL){\r\n\t\t$marks = $rowf10['mScore'];\r\n\t} else {\r\n\t\t$marks = $rowf10['tScore'];\r\n\t}\t\t\t\t\t\t\r\n\t\r\n\t//$marks = $rowf10['mScore'];\r\n\t\r\n\t$temp_array = array($course_id =&gt; array($rowf10['CourseCode'] =&gt; $marks));\r\n\t$exam_id_array = array($course_id =&gt; $rowf10['ExamId']);\r\n\t\r\n\t\r\n\t$report[$status_count]['program'][$program_count]['semester'][$semester_count]['student'][$student_count]['codes'][] = $temp_array;\r\n\t$report[$status_count]['program'][$program_count]['semester'][$semester_count]['student'][$student_count]['examid'][] = $exam_id_array;\r\n\r\n//\tif ($rowf10['CourseCode'] == '8107') {\r\n//\t\techo sprintf(&quot;Student count: %d, marks: %s <br>&quot;, $student_count, $marks);\r\n//\t}\r\n\t\r\n } //end while $rowf10 ...\r\n \r\n//die();\r\n//print_r($report[0]['program'][0]['semester']);\r\n//die();\r\n\r\n// add data to worksheet\r\n//count for sheet lable\r\n$shtCount = 0;\r\n\r\nforeach ($report as $status) {\r\n\t// Get the civil status\r\n\t// Create the work sheet for each civil status at this stage\r\n\t$civil_status_id = $status['status_id'];\r\n\t$cstatus =  $status['civil_status'];\r\n\t\r\n\tforeach ($status['program'] as $program =&gt; $program_data) {\r\n\t\t\t\t\t\r\n\t\t// initialize/reset the statistics array (for subjects done..)\r\n\t\t$student_statistics = array();\r\n\r\n        // Get the programs under each civil status\r\n\t\t$program_id = $program_data['id'];\r\n\t\t\t\t\r\n\t\t$progname = substr($program_data['name'],22);\r\n\t\t$lblSheet = $progname. ' ('. $cstatus.')';\r\n\t\t\r\n\t\t$objPHPExcel-&gt;createSheet();\r\n\t\t$objPHPExcel-&gt;setActiveSheetIndex($shtCount);\r\n\t\t$objPHPExcel-&gt;getActiveSheet()-&gt;setTitle($lblSheet);\r\n\t\t\r\n\t\t// Start cell for the semester title\r\n\t\t//$start_cell_char = &quot;B&quot;;\r\n\t\t$start_col_index = 0;\r\n\r\n\t\t// Start column for the displaying the subject codes; subject codes are displayed below the title for the semester\r\n        // When the loop moves to the next program, a new worksheet is created and the counter is reset to 1\r\n\t\t$column_index = 1;\r\n\t\t\r\n\t\t$rowCount = 3;\r\n\t\t\r\n\t\t// Lookup dictionary for the students\r\n\t\t$student_lookup_dictionary = array();\r\n\t\t\r\n\t\tforeach ($program_data['semester'] as $semester=&gt;$semester_data) {\r\n\t\t\t// This is to pre-empt the maximum execution time problem\r\n\t\t\tset_time_limit(240);\r\n            /**\r\n             * Get the semesters under each program\r\n             * ...but first count how many subjects returned per semester and store it in \r\n             * $columncount...\r\n             */\r\n            \r\n            // Get the semester id\r\n\t\t\t$semester_id = $semester_data['semester_id'];\r\n            \r\n            // Generate the subject fetch query\r\n            $temp_subjects_query = sprintf($query_subjects, $program_id, $civil_status_id, $semester_id);\r\n  \r\n            // Execute the query and store the results\r\n\t\t\t$rstSubjects = mysql_query($temp_subjects_query) or die(mysql_error());\r\n                            \r\n\t\t\t// Get the number of records returned - used to determine the no. of cells to merge\r\n\t\t\t$column_count = mysql_num_rows($rstSubjects) or die(mysql_error());\r\n\r\n\t\t\t/** Next, determine the start and end cell for the semester title\r\n\t\t\t  * This shall have to be computed by the script e.g. if the first cell for semester 1 is B1\r\n\t\t\t  * and semester 1 has 16 subjects, then the last cell shall be B17. The title for semester 2 \r\n\t\t\t  * shall however start at B18. There is therefore a need to have a variable that keeps track of \r\n\t\t\t  * the last cell so as to ensure the titles appear in the correct cell ranges.\r\n\t\t\t  */\r\n\t\t\t$title = ''; // variable to hold title per semester\r\n\t\t\t$style = 1; // variable to hold color and style scheme\r\n\t\t\tswitch ($semester_id) {\r\n\t\t\t\tcase 1:\r\n\t\t\t\t\t// set first year title\r\n\t\t\t\t\t$title = 'Annus I';\r\n\t\t\t\t\t$style = 1;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 2:\r\n\t\t\t\t\t// set second year title\r\n\t\t\t\t\t$title = 'Annus II';\r\n\t\t\t\t\t$style = 2;\r\n\t\t\t\t\t$column_count = $column_count - 1; // to compensate for shifting of $end_col_index...\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 3:\r\n\t\t\t\t\t// set 3rd year title\r\n\t\t\t\t\t$title = 'Annus III';\r\n\t\t\t\t\t$style = 3;\r\n\t\t\t\t\t$column_count = $column_count - 1;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 4:\r\n\t\t\t\t\t// set 4th year title\r\n\t\t\t\t\t$title = 'Annus IV';\r\n\t\t\t\t\t$style = 4;\r\n\t\t\t\t\t$column_count = $column_count - 1;\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\t// Determine the end cell for the semester title\r\n\t\t\t//$end_cell_char = chr(ord($start_cell_char) &#43; $column_count );\r\n\t\t\t$end_col_index = $start_col_index &#43; $column_count;\r\n\r\n\t\t\t$objPHPExcel-&gt;getActiveSheet()-&gt;mergeCellsByColumnAndRow($start_col_index, 1, $end_col_index, 1);\r\n\t\t\t$objPHPExcel-&gt;getActiveSheet()-&gt;setCellValueByColumnAndRow($start_col_index, 1, $title);\r\n\t\t\t$objPHPExcel-&gt;getActiveSheet()-&gt;getStyleByColumnAndRow($start_col_index, 1, $end_col_index, 1)-&gt;applyFromArray(getTitleColorArray($style));\r\n\t\t\t\r\n\t\t\t// Set the start cell to the end cell\r\n\t\t\t//$start_cell_char = chr(ord($end_cell_char) &#43; 1);\r\n\t\t\t$start_col_index = $end_col_index &#43; 1;\r\n\r\n\t\t\t/** \r\n\t\t\t * Create the columns for each subject in the semester at this stage\r\n\t\t\t * NOTE: This will however require the course codes for the semester to have been independently \r\n\t\t\t *fetched in advance\r\n\t\t\t * \r\n\t\t\t */\t\t\r\n\t\t\t\r\n\t\t\t// Lookup buffer for the positioning of the marks\r\n\t\t\t$lookup_dictionary = array();\r\n\t\t\t\r\n\t\t\twhile ($rowSubjects = mysql_fetch_assoc($rstSubjects)) {\r\n\t\t\t\t// Store the column position of each subject\r\n\t\t\t\t$lookup_dictionary[$rowSubjects['CourseCode']] = $column_index;\r\n\t\t\t\t$course_id = $rowSubjects['CourseId'];\r\n\t\t\t\t\r\n\t\t\t\t// Set column values (subject headings) for row 2\r\n\t\t\t\t$objPHPExcel-&gt;getActiveSheet()-&gt;setCellValueByColumnAndRow($column_index, 2, $rowSubjects['CourseCode']);\r\n\t\t\t\t// Set url for retrieving students who have not yet done the course\r\n\t\t\t\t$url_course = $host . 'istudium/ca_list.php?courseID='.$course_id.'&programID='.$program_id. '&civilstatusID='.$civil_status_id; //specifying course, program and civil status...\r\n\t\t\t\t$objPHPExcel-&gt;getActiveSheet()-&gt;getCellByColumnAndRow($column_index, 2)-&gt;getHyperlink()-&gt;setUrl($url_course);\r\n\t\t\t\t$course_name = getCourse($course_id); // get course name to use in tooltip...\r\n\t\t\t\t$objPHPExcel-&gt;getActiveSheet()-&gt;getCellByColumnAndRow($column_index, 2)-&gt;getHyperlink()-&gt;setTooltip('Click to view students who have not yet done ['.$course_name.']');\r\n\t\t\t\t\r\n\t\t\t\t// Increment the column count\r\n\t\t\t\t$column_index&#43;&#43;;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// Explicitly free the result handle though the MySQL engine implictly does this after a record fetch\r\n            @mysql_free_result($rstSubjects) or die(mysql_error());\r\n\t\t\t\r\n\t\t\tforeach ($semester_data['student'] as $student=&gt;$student_data) {\r\n\t\t\t\t/**\r\n                  * Get the students under each semester\r\n                  * It is in this iteration that the row count for the report is incremented\r\n                  */\r\n                $name = getStudentName($student_data['student_id']);\r\n\t\t\t\t$student_id = $student_data['student_id'];\r\n\t\t\t\t\r\n\t\t\t\t// Check if the student id exists in the dictionary\r\n\t\t\t\tif ( ! array_key_exists($student_id, $student_lookup_dictionary)){\r\n\t\t\t\t\t$student_lookup_dictionary[$student_id] = $rowCount;\r\n\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t$objPHPExcel-&gt;setActiveSheetIndex($shtCount);\r\n\t\t\t\t\r\n\t\t\t\t// Get the row index for the student's data\r\n\t\t\t\t// This is necessary so that the data for students who appear across semesters within the same program\r\n\t\t\t\t// appears in the same row in the Excel report\r\n\t\t\t\t$row_index = $student_lookup_dictionary[$student_id];\r\n\r\n\t\t\t\t// Enter name of student in first column\r\n\t\t\t\t$objPHPExcel-&gt;getActiveSheet()-&gt;setCellValueByColumnAndRow(0, $row_index, $name);\r\n\t\t\t\t\r\n\t\t\t\t// Get the url for downloading students F10...\r\n\t\t\t\t$url =  $host . 'istudium/admin_view_transcript.php?studentID='.$student_id;\r\n\t\t\t\t\r\n\t\t\t\t$objPHPExcel-&gt;getActiveSheet()-&gt;getCellByColumnAndRow(0, \r\n\t\t\t\t\t$row_index)-&gt;getHyperlink()-&gt;setUrl($url);\r\n\r\n\t\t\t\t$objPHPExcel-&gt;getActiveSheet()-&gt;getCellByColumnAndRow(0, \r\n\t\t\t\t\t$row_index)-&gt;getHyperlink()-&gt;setTooltip('Click to download F10');\r\n\t\t\t\t\t\r\n\t\t\t\t// Get the row_index (or student_id) in order to determine the row in which the student appears in the excel report;\r\n\t\t\t\t// when $student_id is used in the array, the values at the bottom of the xls sheet are truncated?!\r\n\t\t\t\tif ( ! array_key_exists($row_index, $student_statistics)) {\r\n\t\t\t\t\t$student_statistics[$row_index] = array();\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tforeach ($student_data['codes'] as $course_code=&gt;$course_data) {\r\n\t\t\t\t\t// This is to pre-empt the maximum execution time problem\r\n\t\t\t\t\t//set_time_limit(240);\r\n                    // Get the subjects/codes and marks under each student\r\n\t\t\t\t\tforeach ($course_data as $course_id =&gt; $course_id_data) {\r\n                        $item_counter = 0;\r\n\t\t\t\t\r\n                        foreach ($course_id_data as $course_code=&gt;$mark) {\r\n\t\t\t\t\t\t\tif (array_key_exists($course_code, $lookup_dictionary)) {\r\n\t\t\t\t\t\t\t\t$mark_column = $lookup_dictionary[$course_code];\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t// Get the exam ID for the current subject\r\n\t\t\t\t\t\t\t\tif (isset($student_data['examid'][$item_counter][($item_counter&#43;1)])){\r\n\t\t\t\t\t\t\t\t\t$cur_exam_id = $student_data['examid'][$item_counter][($item_counter&#43;1)];\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t// Enter mark; the column co-ordinate corresponds to the subjects above...\r\n\t\t\t\t\t\t\t\t$objPHPExcel-&gt;getActiveSheet()-&gt;setCellValueByColumnAndRow($mark_column,\r\n\t\t\t\t\t\t\t\t\t$row_index, $mark);\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t// Determine the no. of subjects sat for by the student using the $students_statistics array...(increment the no. of subjects sat for by the student)\r\n\t\t\t\t\t\t\t\t$student_codes = $student_statistics[$row_index];\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tif (isset($mark) && $mark &gt; 0 && !in_array($course_code, $student_codes)) {\r\n\t\t\t\t\t\t\t\t\tarray_push($student_codes, $course_code);\r\n\t\t\t\t\t\t\t\t\t$student_statistics[$row_index] = $student_codes;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t// shade the cells...\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t$cellColor = '';\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tif ($mark &gt;= 70) {\r\n\t\t\t\t\t\t\t\t\t$cellColor = $light_green;\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t} elseif ($mark &gt;= 50 && $mark &lt;=69) {\r\n\t\t\t\t\t\t\t\t\t$cellColor = $amber;\r\n\t\t\t\t\t\t\t\t} elseif ($mark &gt;= 1 && $mark &lt;=49) {\r\n\t\t\t\t\t\t\t\t\t$cellColor = $red;\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\t// just leave it blank\r\n\t\t\t\t\t\t\t\t\t$cellColor = $white;\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t}\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t$objPHPExcel-&gt;getActiveSheet()-&gt;getStyleByColumnAndRow($mark_column, \r\n\t\t\t\t\t\t\t\t\t$row_index)-&gt;getFill()-&gt;setFillType(PHPExcel_Style_Fill::FILL_SOLID);\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t$objPHPExcel-&gt;getActiveSheet()-&gt;getStyleByColumnAndRow($mark_column, \r\n\t\t\t\t\t\t\t\t\t$row_index)-&gt;getFill()-&gt;getStartColor()-&gt;setRGB($cellColor);\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t$objPHPExcel-&gt;getActiveSheet()-&gt;getStyleByColumnAndRow($mark_column, \r\n\t\t\t\t\t\t\t\t\t$row_index)-&gt;getFont()-&gt;getColor()-&gt;setRGB($cellColor);\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t// set hyperlink to folders that contain actae...\r\n\t\t\t\t\t\t\t\t//$today = date('Y-m-d');\r\n\t\t\t\t\t\t\t\t//$date = explode(&quot;-&quot;, $today);\r\n\t\t\t\t\t\t\t\t//obtain course name to use in tooltip...\r\n\t\t\t\t\t\t\t\t$course_name = getCourse($course_id);\r\n\t\t\t\t\t\t\t\t//obtain url for Acta\r\n\t\t\t\t\t\t\t\t//$url2 = &quot;http://&quot; . $_SERVER['HTTP_HOST'] . '/istudium/result_summary2.php?courseID='.$course_id.'&examID='.$cur_exam_id;\r\n\t\t\t\t\t\t\t\t$url2 = $host . 'istudium/result_summary3.php?courseID='.$course_id.'&programID='.$program_id. '&civilstatusID='.$civil_status_id; //specifying course, program and civil status...\r\n\t\t\t\t\t\t\t\t//$url2 = $host . 'istudium/result_summary3.php?courseID='.$course_id;\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t$objPHPExcel-&gt;getActiveSheet()-&gt;getCellByColumnAndRow($mark_column, \r\n\t\t\t\t\t\t\t\t\t$row_index)-&gt;getHyperlink()-&gt;setUrl($url2);\r\n\t\t\t\t\t\t\t\t$objPHPExcel-&gt;getActiveSheet()-&gt;getCellByColumnAndRow($mark_column, \r\n\t\t\t\t\t\t\t\t\t$row_index)-&gt;getHyperlink()-&gt;setTooltip('Click to view the ['.$course_name.'] Acta');\r\n\r\n\t\t\t\t\t\t\t\t// Setting borders...\r\n\t\t\t\t\t\t\t\t$objPHPExcel-&gt;getActiveSheet()-&gt;getStyleByColumnAndRow($mark_column, \r\n\t\t\t\t\t\t\t\t\t$row_index)-&gt;getBorders()-&gt;getAllBorders()-&gt;setBorderStyle(PHPExcel_Style_Border::BORDER_THIN);\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t// Set border colors\r\n\t\t\t\t\t\t\t\t$objPHPExcel-&gt;getActiveSheet()-&gt;getStyleByColumnAndRow($mark_column, \r\n\t\t\t\t\t\t\t\t\t$row_index)-&gt;getBorders()-&gt;getAllBorders()-&gt;getColor()-&gt;setARGB('FF993300');\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t// Set column width\r\n\t\t\t\t\t\t\t\t//$objPHPExcel-&gt;getActiveSheet()-&gt;getColumnDimension($mark_column)-&gt;setWidth(12);\r\n\t\t\t\t\t\t\t\t$objPHPExcel-&gt;getActiveSheet()-&gt;getColumnDimension('A')-&gt;setAutoSize(true);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t$item_counter&#43;&#43;;\r\n\t\t\t\t\t\r\n\t\t\t\t\t\t} // foreach $course_id_data\r\n\t\t\t\t\t\r\n\t\t\t\t\t} // end foreach $course_data\r\n\t\t\t\t\t\r\n\t\t\t\t} //end foreach $student_data\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t$rowCount &#43;&#43;;\r\n\t\t\t\r\n\t\t\t} // foreach $semester_data\r\n\t\t\t\r\n\t\t} // foreach program_data\r\n\r\n\t\t//Calculate the total number of subjects/courses per program...\r\n\t\t$query_subj = &quot;SELECT * FROM courses WHERE ProgramId = $program_id ORDER BY Course ASC&quot;;\r\n\t\t$result_subj = mysql_query($query_subj);\r\n\t\t$num_subjects = mysql_num_rows($result_subj);\r\n\t\t\r\n\t\t// Set the headings for the stats...\r\n\t\t$objPHPExcel-&gt;getActiveSheet()-&gt;setCellValueByColumnAndRow($column_index, 2, 'Done');\r\n\t\t$objPHPExcel-&gt;getActiveSheet()-&gt;getStyleByColumnAndRow($column_index, 2)\r\n\t\t\t-&gt;getAlignment()-&gt;setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_RIGHT);\r\n\t\t$objPHPExcel-&gt;getActiveSheet()-&gt;setCellValueByColumnAndRow($column_index &#43; 1, 2, 'Pending');\r\n\t\t$objPHPExcel-&gt;getActiveSheet()-&gt;getStyleByColumnAndRow($column_index &#43; 1, 2)\r\n\t\t\t-&gt;getAlignment()-&gt;setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_RIGHT);\r\n\t\t\r\n\t\tforeach($student_statistics as $key =&gt; $value) {\r\n\t\t\t// Output subjects done...in last column...\r\n\t\t\t$objPHPExcel-&gt;getActiveSheet()-&gt;setCellValueByColumnAndRow($column_index, $key, count($value));\r\n            \r\n            // Caclculate the no. of subjects pending\r\n            $subjects_pending = $num_subjects - count($value);\r\n            \r\n\t\t\t// Output subjects pending...in next column...\r\n\t\t\t$objPHPExcel-&gt;getActiveSheet()-&gt;setCellValueByColumnAndRow($column_index &#43; 1, $key, $subjects_pending);\r\n\t\t}\r\n\t\t\r\n\t\t/**\r\n\t\t * // retains $student_stats (subjects done by n) for custom_reports2.php...\r\n\t\t * if ($program_id == 3 && $civil_status_id == 1){\r\n\t\t *\t//$student_stats = array(); // new variable to keep just the subjects for civil status n...\r\n\t\t *\t//$student_stats = $student_statistics;\r\n\t\t *\t$_SESSION['student_stats'] =  $student_stats;\r\n\t\t *\t//var_dump($_SESSION['student_stats']);\r\n\t\t *\t//print_r($_SESSION['student_stats']);\r\n\t\t *\t//print_r(count($student_stats));\r\n\t\t *\t//die;\r\n\t\t * }\r\n\t\t * //print_r($student_statistics);\r\n\t\t * //die;\r\n\t\t */\r\n\r\n\t\t // Increment the sheet count\r\n\r\n\t\t$shtCount&#43;&#43;;\r\n\r\n\t} // end foreach $status...\r\n\r\n} // end foreach $report\r\n//die();\r\n// fetch recordset for the key sheet\r\n$query_key = &quot;SELECT c.CourseId, c.CourseCode, c.Course, s.SpecializationId, s.SName \r\n\t\t\tFROM courses c \r\n\t\t\tLEFT JOIN specializations s ON c.SpecializationId = s.SpecializationId\r\n\t\t\tWHERE c.ProgramId IN (1, 3) \r\n\t\t\tORDER BY c.CourseId ASC &quot;;\r\n\r\n$rst_key = mysql_query($query_key) or die(mysql_error());\r\n// set the key sheet\r\n$objPHPExcel-&gt;createSheet();\r\n$objPHPExcel-&gt;setActiveSheetIndex($shtCount);\r\n$objPHPExcel-&gt;getActiveSheet()-&gt;setTitle(&quot;Report Key&quot;);\r\n// set row count for the values...\r\n$row_count = 3;\r\nwhile ($row_key = mysql_fetch_assoc($rst_key)) {\r\n\t// Set code and subject headings...\r\n\t$objPHPExcel-&gt;getActiveSheet()-&gt;setCellValue('A1', 'Code');\r\n\t$objPHPExcel-&gt;getActiveSheet()-&gt;setCellValue('B1', 'Subject');\r\n\t$objPHPExcel-&gt;getActiveSheet()-&gt;setCellValue('C1', 'Credits');\r\n\t$objPHPExcel-&gt;getActiveSheet()-&gt;getStyle('E8')-&gt;getFill()-&gt;setFillType(PHPExcel_Style_Fill::FILL_SOLID);\r\n\t$objPHPExcel-&gt;getActiveSheet()-&gt;getStyle('E9')-&gt;getFill()-&gt;setFillType(PHPExcel_Style_Fill::FILL_SOLID);\r\n\t$objPHPExcel-&gt;getActiveSheet()-&gt;getStyle('E10')-&gt;getFill()-&gt;setFillType(PHPExcel_Style_Fill::FILL_SOLID);\r\n\t$objPHPExcel-&gt;getActiveSheet()-&gt;getStyle('E8')-&gt;getFill()-&gt;getStartColor()-&gt;setRGB($light_green);\r\n\t$objPHPExcel-&gt;getActiveSheet()-&gt;getStyle('E9')-&gt;getFill()-&gt;getStartColor()-&gt;setRGB($amber);\r\n\t$objPHPExcel-&gt;getActiveSheet()-&gt;getStyle('E10')-&gt;getFill()-&gt;getStartColor()-&gt;setRGB($red);\r\n\t// setting borders...\r\n\t$objPHPExcel-&gt;getActiveSheet()-&gt;getStyle('E8')-&gt;getBorders()-&gt;getAllBorders()-&gt;setBorderStyle(PHPExcel_Style_Border::BORDER_THIN);\r\n\t$objPHPExcel-&gt;getActiveSheet()-&gt;getStyle('E9')-&gt;getBorders()-&gt;getAllBorders()-&gt;setBorderStyle(PHPExcel_Style_Border::BORDER_THIN);\r\n\t$objPHPExcel-&gt;getActiveSheet()-&gt;getStyle('E10')-&gt;getBorders()-&gt;getAllBorders()-&gt;setBorderStyle(PHPExcel_Style_Border::BORDER_THIN);\r\n\t// Set border colors\r\n\t$objPHPExcel-&gt;getActiveSheet()-&gt;getStyle('E8')-&gt;getBorders()-&gt;getAllBorders()-&gt;getColor()-&gt;setARGB('FF993300');\r\n\t$objPHPExcel-&gt;getActiveSheet()-&gt;getStyle('E8')-&gt;getBorders()-&gt;getAllBorders()-&gt;getColor()-&gt;setARGB('FF993300');\r\n\t$objPHPExcel-&gt;getActiveSheet()-&gt;getStyle('E8')-&gt;getBorders()-&gt;getAllBorders()-&gt;getColor()-&gt;setARGB('FF993300');\r\n\t// set the values \r\n\t$objPHPExcel-&gt;getActiveSheet()-&gt;setCellValue('F8', 'Exam done successfully');\r\n\t$objPHPExcel-&gt;getActiveSheet()-&gt;setCellValue('F9', 'Exam pending');\r\n\t$objPHPExcel-&gt;getActiveSheet()-&gt;setCellValue('F10', 'Resit');\r\n\r\n\t// populate the code, subject and credit values from recordset..\r\n\t$objPHPExcel-&gt;getActiveSheet()-&gt;setCellValueByColumnAndRow(0, $row_count, $row_key['CourseCode']);\r\n\t$objPHPExcel-&gt;getActiveSheet()-&gt;setCellValueByColumnAndRow(1, $row_count, $row_key['Course']);\r\n\t$objPHPExcel-&gt;getActiveSheet()-&gt;setCellValueByColumnAndRow(2, $row_count, $row_key['SName']);\r\n\t// set column 'B' to autosize...\r\n\t$objPHPExcel-&gt;getActiveSheet()-&gt;getColumnDimension('B')-&gt;setAutoSize(true);\r\n\t//$objPHPExcel-&gt;getActiveSheet()-&gt;getColumnDimension('B')-&gt;setWidth(14);\r\n\t\r\n\t// Increment the row count\r\n\t$row_count&#43;&#43;;\r\n}\r\n\r\n//Set up the document for display\r\n$sheet = 0;\r\nforeach ($objPHPExcel-&gt;getWorksheetIterator() as $worksheet) {\r\n\t$objPHPExcel-&gt;setActiveSheetIndex($sheet);\r\n\t$objPHPExcel-&gt;getActiveSheet()-&gt;getPageSetup()-&gt;setHorizontalCentered(true);\r\n\t$objPHPExcel-&gt;getActiveSheet()-&gt;getPageSetup()-&gt;setVerticalCentered(false);\r\n\t//$objPHPExcel-&gt;getActiveSheet()-&gt;setTitle('Change Report');\r\n\t$objPHPExcel-&gt;getActiveSheet()-&gt;getDefaultStyle()-&gt;getFont()-&gt;setName('Calibri');\r\n\t$objPHPExcel-&gt;getActiveSheet()-&gt;getDefaultStyle()-&gt;getFont()-&gt;setSize(10);\r\n\t$objPHPExcel-&gt;getActiveSheet()-&gt;freezePaneByColumnAndRow(1, 3);\r\n\t$sheet&#43;&#43;;\r\n}\r\n\r\n\r\n//Flush the MySQL resource handle used for the data fetch\r\nmysql_free_result($rstf10) or die(mysql_error());\r\n//mysql_free_result($rstSubjects) or die(mysql_error());... already done above.\r\nmysql_free_result($rst_key) or die(mysql_error());\r\n\r\n//print_r($report[0]['program'][0]['semester'][0]);\r\n//die;\r\n//print_r($report[0]['program'][0]['semester'][0]['student'][53]);\r\n//die;\r\n//print_r($report);\r\n//die;\r\n\r\n\t\t\t\t\r\n//Set active sheet index to the first sheet, so Excel opens this as the first sheet\r\n$objPHPExcel-&gt;setActiveSheetIndex(0);\r\n//var_dump(iconv('UTF-8', 'UTF-16LE', 'x'));\r\n\r\n\r\n// clear buffer\r\nob_end_clean();\r\n//Redirect output to a client�s web browser (Excel2007)\r\nheader('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\r\nheader('Content-Disposition: attachment;filename=&quot;StatusReport-'.date('dMY').'.xlsx&quot;');\r\nheader('Cache-Control: max-age=0');\r\n\r\n$objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel2007');\r\n//Clean (erase) the output buffer and turn off output buffering\r\nob_end_clean();\r\n$objWriter-&gt;save('php://output');\r\n//$objWriter-&gt;save(str_replace('.php', '.xlsx', __FILE__));\r\n//exit;\r\n\t\t\t\t\r\n/*\r\n// or save to disc..\r\n$writer = new PHPExcel_Writer_Excel2007($objPHPExcel);\r\n$writer-&gt;save('Reports/Report-'. date('dMY').'.xlsx');\r\n            \r\necho date('H:i:s') . &quot; Download Complete\\n&quot;;\r\n*/\r\n// clear workbook from memory...\r\n$objPHPExcel-&gt;disconnectWorksheets();\r\nunset($objPHPExcel);\r\n//Delete the arrays\r\nunset($report);\r\nunset($lookup_dictionary);\r\nunset($student_lookup_dictionary);\r\nunset ($student_statistics);\r\nexit;\r\n?&gt;</pre>\r\n<p></p>\r\n<div id=\"_mcePaste\" style=\"left:-10000px; top:0px; width:1px; height:1px; overflow:hidden\">\r\nfidelnamisi@gmail.com</div>\r\n",
    "PostedDate": "2012-12-21T05:04:57.437-08:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  }
]