[
  {
    "Id": "1307099",
    "ThreadId": "568081",
    "Html": "Hello!\r<br />\n<br />\nI created a simple program which is supposed to search 'query' in the first column of all .xls or .xlsx files in a given 'directory' and then return each row (6 cells) where 1st cell is matching 'query', grouping them as a table.\r<br />\n<br />\nThis program actually works as it was supposed, but it's VERY slow to be usable. The script is working about 400 seconds and more, also it takes a lot of memory - up to several hundreds of Mb for some large files. In the 'directory' I have 38 .xls and .xlsx files each up to 5 Mb of size (~ up to 120 000 rows).\r<br />\n<br />\nSo my question: is it possible to speed up somehow the program (maybe the algorythm in general or the way I use PHPExcel) to consume some reasonable amount of time (several seconds)? Would be ideal to speed it up to 1 second or less. Thank you in advance!\r<br />\n<br />\nMy code:<br />\n<div style=\"color:Black;background-color:White;\"><pre>\r\n&lt;?php\n<span style=\"color:Green;\">/** Error reporting */</span>\nerror_reporting(E_ALL);\nini_set(<span style=\"color:#A31515;\">&#39;display_errors&#39;</span>, TRUE); \nini_set(<span style=\"color:#A31515;\">&#39;display_startup_errors&#39;</span>, TRUE); \n\ndefine(<span style=\"color:#A31515;\">&#39;EOL&#39;</span>,(PHP_SAPI == <span style=\"color:#A31515;\">&#39;cli&#39;</span>) ? PHP_EOL : <span style=\"color:#A31515;\">&#39;&lt;br /&gt;&#39;</span>);\n\n<span style=\"color:Green;\">/** Include PHPExcel */</span>\n<span style=\"color:Blue;\">require_once</span> dirname(<span style=\"color:Blue;\">__FILE__</span>) . <span style=\"color:#A31515;\">&#39;/../../PHPExcel/Classes/PHPExcel.php&#39;</span>;\n\ndate_default_timezone_set(<span style=\"color:#A31515;\">&#39;UTC&#39;</span>);\n\n<span style=\"color:Blue;\">if</span>(<span style=\"color:Blue;\">isset</span>($_POST[<span style=\"color:#A31515;\">&#39;query&#39;</span>]) &amp;&amp; trim($_POST[<span style=\"color:#A31515;\">&#39;query&#39;</span>]) != <span style=\"color:#A31515;\">&#39;&#39;</span>)\n{\n    $dir    = dirname(<span style=\"color:Blue;\">__FILE__</span>);\n    $files = scandir($dir);\n    $found = False;\n    \n    <span style=\"color:Blue;\">print</span> <span style=\"color:#A31515;\">&quot;&lt;html&gt;&lt;head&gt;&lt;meta http-equiv=\\&quot;Content-Type\\&quot; content=\\&quot;text/html; charset=utf-8\\&quot;&gt;&lt;title&gt;Test search&lt;/title&gt;&quot;</span>;\n    <span style=\"color:Blue;\">print</span> <span style=\"color:#A31515;\">&quot;&lt;table border=1&gt;\\n&quot;</span>;\n    \n    <span style=\"color:Blue;\">print</span> <span style=\"color:#A31515;\">&quot;&lt;tr&gt;\\n&quot;</span>;\n    <span style=\"color:Blue;\">print</span> <span style=\"color:#A31515;\">&quot;&lt;td&gt;Col1&lt;/td&gt;&lt;td&gt;Col2&lt;/td&gt;&lt;td&gt;Col3&lt;/td&gt;&lt;td&gt;Col4&lt;/td&gt;&lt;td&gt;Col5&lt;/td&gt;&lt;td&gt;Col6&lt;/td&gt;&quot;</span>;\n    <span style=\"color:Blue;\">print</span> <span style=\"color:#A31515;\">&quot;&lt;/tr&gt;\\n&quot;</span>;\n    \n    \n    <span style=\"color:Blue;\">for</span>($i=0;$i&lt;count($files);$i++){    \n        $<span style=\"color:Blue;\">file</span>=$files[$i];\n        $is_xls = stripos($<span style=\"color:Blue;\">file</span>, <span style=\"color:#A31515;\">&quot;.xls&quot;</span>);\n        $is_xlsx = stripos($<span style=\"color:Blue;\">file</span>, <span style=\"color:#A31515;\">&quot;.xlsx&quot;</span>);\n        <span style=\"color:Blue;\">if</span>($is_xls === False &amp;&amp; $is_xlsx === False)\n            <span style=\"color:Blue;\">continue</span>;\n        $pathToFile =  $dir.<span style=\"color:#A31515;\">&quot;/&quot;</span>.$<span style=\"color:Blue;\">file</span>;\n        $inputFileType = PHPExcel_IOFactory::identify($pathToFile);\n        $objReader = PHPExcel_IOFactory::createReader($inputFileType);\n        $objReader-&gt;setReadDataOnly(true);\n        $objPHPExcel = $objReader-&gt;load($pathToFile);\n        $objWorksheet = $objPHPExcel-&gt;getActiveSheet();\n        <span style=\"color:Green;\">// Get the highest row and column numbers referenced in the worksheet</span>\n        $highestRow = $objWorksheet-&gt;getHighestRow(); \n        $highestColumn = $objWorksheet-&gt;getHighestColumn(); \n        $highestColumnIndex = PHPExcel_Cell::columnIndexFromString($highestColumn);\n        \n        $query = str_replace(<span style=\"color:#A31515;\">&#39;-&#39;</span>, <span style=\"color:#A31515;\">&#39;&#39;</span>, preg_replace(<span style=\"color:#A31515;\">&#39;/\\s+/&#39;</span>, <span style=\"color:#A31515;\">&#39;&#39;</span>, strtolower(trim($_POST[<span style=\"color:#A31515;\">&#39;query&#39;</span>]))));\n        \n        <span style=\"color:Blue;\">for</span>($row=1;$row&lt;$highestRow;$row++){\n        \n            $firstColumn = $objWorksheet-&gt;getCellByColumnAndRow(0, $row)-&gt;getValue();\n            $name = str_replace(<span style=\"color:#A31515;\">&#39;-&#39;</span>, <span style=\"color:#A31515;\">&#39;&#39;</span>, preg_replace(<span style=\"color:#A31515;\">&#39;/\\s+/&#39;</span>, <span style=\"color:#A31515;\">&#39;&#39;</span>, strtolower(trim($firstColumn))));\n            $pos = strpos($name, $query);\n            <span style=\"color:Blue;\">if</span>( $pos == True || $pos === 0){\n                $found=True;\n                <span style=\"color:Blue;\">print</span> <span style=\"color:#A31515;\">&quot;&lt;tr&gt;\\n&quot;</span>;\n                <span style=\"color:Blue;\">print</span> <span style=\"color:#A31515;\">&quot;&lt;td&gt;&quot;</span>.$objWorksheet-&gt;getCellByColumnAndRow(0, $row)-&gt;getValue().&quot;&lt;/td&gt;\n                &lt;td&gt;<span style=\"color:#A31515;\">&quot;.$objWorksheet-&gt;getCellByColumnAndRow(1, $row)-&gt;getValue().&quot;</span>&lt;/td&gt;\n                &lt;td&gt;<span style=\"color:#A31515;\">&quot;.$objWorksheet-&gt;getCellByColumnAndRow(2, $row)-&gt;getValue().&quot;</span>&lt;/td&gt;\n                &lt;td&gt;<span style=\"color:#A31515;\">&quot;.$objWorksheet-&gt;getCellByColumnAndRow(3, $row)-&gt;getValue().&quot;</span>&lt;/td&gt;\n                &lt;td&gt;<span style=\"color:#A31515;\">&quot;.$objWorksheet-&gt;getCellByColumnAndRow(4, $row)-&gt;getValue().&quot;</span>&lt;/td&gt;\n                &lt;td&gt;<span style=\"color:#A31515;\">&quot;.$objWorksheet-&gt;getCellByColumnAndRow(5, $row)-&gt;getValue().&quot;</span>&lt;/td&gt;\\n&quot;;\n                <span style=\"color:Blue;\">print</span> <span style=\"color:#A31515;\">&quot;&lt;/tr&gt;\\n&quot;</span>;\n            }\n        }\n        \n        $objPHPExcel-&gt;disconnectWorksheets();\n        <span style=\"color:Blue;\">unset</span>($objReader);\n        <span style=\"color:Blue;\">unset</span>($objPHPExcel);\n        <span style=\"color:Blue;\">unset</span>($objWorksheet);\n    }\n    <span style=\"color:Blue;\">if</span>(!$found){\n        <span style=\"color:Blue;\">print</span> <span style=\"color:#A31515;\">&quot;&lt;tr&gt;\\n&quot;</span>;\n        <span style=\"color:Blue;\">print</span> <span style=\"color:#A31515;\">&quot;&lt;td&gt;Nothing found.&lt;/td&gt;\\n&quot;</span>;\n        <span style=\"color:Blue;\">print</span> <span style=\"color:#A31515;\">&quot;&lt;/tr&gt;\\n&quot;</span>;\n    }\n    <span style=\"color:Blue;\">print</span> <span style=\"color:#A31515;\">&quot;&lt;/table&gt;\\n&quot;</span>;\n} <span style=\"color:Blue;\">else</span>\n<span style=\"color:Green;\"># If &quot;search&quot; parameter doesn&#39;t exist, show an error and exit </span>\n{\n    header(<span style=\"color:#A31515;\">&quot;HTTP/1.1 500 Internal Server Error&quot;</span>);\n<span style=\"color:Blue;\">print</span> <span style=\"color:#A31515;\">&quot;&lt;h1&gt;500 Internal Server Error&lt;/h1&gt;&quot;</span>.\n      <span style=\"color:#A31515;\">&quot;Request is not set&quot;</span>;\n<span style=\"color:Blue;\">exit</span>;\n}\r\n</pre></div>My software:\r<br />\nPHPExcel 1.8.0\r<br />\nPHP 5.6.0\r<br />\nApache 2.4.10\r<br />\nWindows 7<br />\n",
    "PostedDate": "2014-09-22T11:26:05.217-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  },
  {
    "Id": "1307186",
    "ThreadId": "568081",
    "Html": "Suggestion would be to use read filters, and do each file in 2 passes: Use a first read filter just to read column A, as that's what you're searching on; do your search and build an array of the rows where you find your matches.... then (only if you actually find matches in that file) use the second pass to read the rows that you want, using a second read filter just to retrieve those rows,\r<br />\n<br />\nBut if you're looking to get this down to 1 second per file, then I'd suggest paying for a license for the commercial <a href=\"http://www.libxl.com/\" rel=\"nofollow\">libXl</a> and using <a href=\"https://github.com/iliaal/php_excel\" rel=\"nofollow\">Ilia's</a> wrapper extension to access that<br />\n",
    "PostedDate": "2014-09-22T15:34:19.907-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  }
]